<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë‹¬ ì¡°ë‚œ ìƒí™© ìƒì¡´ ì‹œë®¬ë ˆì´ì…˜ (ëª¨ë‘  í™œë™ìš©)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!--
        Copyright (c) 2025 [Pinky]
        This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
        You should have received a copy of the license along with this work. If not, see <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0a192f;
            color: #e6f1ff;
        }
        #app-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .screen { display: none; }
        .active-screen { display: block; }
        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: #94a3b8;
        }
        .drag-handle:hover {
            color: #e2e8f0;
        }
        .sortable-ghost {
            background: #4a5568;
            opacity: 0.5;
        }
        .modal-base {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0s 0.2s;
        }
        .modal-base.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease;
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 2rem;
            width: 95%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        .modal-base.show .modal-content {
            transform: scale(1);
        }
        #emergency-screen {
            background-color: #000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 200;
        }
        #emergency-message-container p {
            opacity: 0;
            animation: fadeIn 1.5s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .rank-slot.empty {
            cursor: pointer;
            border-style: dashed;
        }
        .rank-slot.empty:hover {
            background-color: #334155; /* slate-700 */
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="app-wrapper">
        <div id="app-container" class="w-full max-w-7xl mx-auto bg-[#172a46] bg-opacity-80 backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8">

            <!-- Screen 1: Intro -->
            <div id="intro-screen" class="screen active-screen text-center">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-4">ë‹¬ì—ì„œ ê¸¸ì„ ìƒë‹¤ (ëª¨ë‘  í™œë™ìš©)</h1>
                <p class="text-base sm:text-lg md:text-xl text-slate-300 mb-6 max-w-3xl mx-auto">
                    ë‹¹ì‹ ì´ íƒ„ ìš°ì£¼ì„ ì´ ë‹¬ì— ë¶ˆì‹œì°©í–ˆìŠµë‹ˆë‹¤.<br>
                    ì‚´ì•„ë‚¨ê¸° ìœ„í•´, ì•½ 300km ë–¨ì–´ì§„ êµ¬ì¡°ì„ ê¹Œì§€ ê°€ì•¼ í•©ë‹ˆë‹¤.<br>
                    ë¨¼ì € ê°œì¸ì˜ ìƒê°ìœ¼ë¡œ, ì´í›„ ëª¨ë‘ ì›ê³¼ í† ì˜í•˜ì—¬ 15ê°œ ë¬¼í’ˆì˜ ìƒì¡´ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ë³´ì„¸ìš”!
                </p>
                <div class="max-w-sm mx-auto mb-8 space-y-4">
                    <div>
                        <label for="groupNameInput" class="block mb-2 text-sm font-medium text-slate-300">ëª¨ë‘  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                        <input type="text" id="groupNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) 1ëª¨ë‘ , AíŒ€" required>
                    </div>
                    <div>
                        <label for="studentNumberInput" class="block mb-2 text-sm font-medium text-slate-300">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
                        <select id="studentNumberInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" required>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="studentNameInput" class="block mb-2 text-sm font-medium text-slate-300">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                        <input type="text" id="studentNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) í™ê¸¸ë™" required>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <button id="start-mission-btn" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ëª¨ë‘  ë¯¸ì…˜ ì‹œì‘
                    </button>
                    <a href="https://moon-survival.pages.dev" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ê°œì¸ í™œë™ ë°”ë¡œê°€ê¸°
                    </a>
                </div>
                <p class="text-xs text-slate-500 mt-8">made by.í•‘í‚¤ë„¤</p>
            </div>
            
            <!-- Screen 2: Role Selection -->
            <div id="role-screen" class="screen">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6">ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <p class="text-center text-slate-300 mb-8">ì„ íƒí•œ ì—­í• ì— ë”°ë¼ íŠ¹ë³„í•œ ì „ë¬¸ ì§€ì‹ì„ ì–»ê²Œ ë©ë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div data-role="scientist" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ”¬</div>
                        <h3 class="text-xl sm:text-2xl font-bold">ìš°ì£¼ê³¼í•™ì</h3>
                        <p class="text-slate-400 text-sm sm:text-base">ë‹¬ì˜ í™˜ê²½ê³¼ ë¬¼ë¦¬ ë²•ì¹™ì— ëŒ€í•´ ê¹Šì´ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="explorer" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ§­</div>
                        <h3 class="text-xl sm:text-2xl font-bold">íƒí—˜ê°€</h3>
                        <p class="text-slate-400 text-sm sm:text-base">í—˜ë‚œí•œ ì§€í˜•ì„ ëŒíŒŒí•˜ê³  ê¸¸ì„ ì°¾ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="communicator" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ“¡</div>
                        <h3 class="text-xl sm:text-2xl font-bold">í†µì‹ ì „ë¬¸ê°€</h3>
                        <p class="text-slate-400 text-sm sm:text-base">ì¥ë¹„ë¥¼ í™œìš©í•´ êµ¬ì¡° ì‹ í˜¸ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="medic" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ©º</div>
                        <h3 class="text-xl sm:text-2xl font-bold">ì˜ë£Œì§„</h3>
                        <p class="text-slate-400 text-sm sm:text-base">ê·¹í•œ ìƒí™©ì—ì„œ ìƒëª…ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            
            <!-- Screen 3: Knowledge Briefing -->
            <div id="knowledge-screen" class="screen">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-2">ì „ë¬¸ ì§€ì‹ ë¸Œë¦¬í•‘</h2>
                <p id="role-title" class="text-center text-orange-400 font-bold text-lg mb-6"></p>
                <div id="knowledge-list" class="bg-slate-800 p-4 sm:p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4 text-slate-300 max-h-[60vh] overflow-y-auto">
                    <!-- Knowledge items will be injected here by JS -->
                </div>
                <div class="text-center mt-8">
                    <button id="go-to-ranking-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ë‚´ ìˆœìœ„ ì •í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- Screen 4: Main Ranking Activity (Individual) -->
            <div id="main-screen" class="screen">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center flex-grow">[ê°œì¸] ìƒì¡´ ë¬¼í’ˆ ìš°ì„ ìˆœìœ„ ì •í•˜ê¸°</h2>
                    <button id="open-knowledge-modal-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0 w-full sm:w-auto">
                        ë‚´ ì „ë¬¸ì§€ì‹ ë³´ê¸° ğŸ§ 
                    </button>
                </div>
                <div id="rank-list" class="w-full bg-slate-800 p-4 rounded-lg min-h-[60vh] space-y-3 max-h-[65vh] overflow-y-auto">
                   <!-- Ranking slots will be generated here -->
                </div>
                 <div class="text-center mt-8">
                      <button id="finish-individual-button" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                          ê°œì¸ ìˆœìœ„ ì œì¶œí•˜ê¸° <span id="finish-individual-button-counter">(0/15)</span>
                      </button>
                 </div>
            </div>
            
            <!-- Screen 4.5: Transition Screen -->
            <div id="transition-screen" class="screen text-center">
                <h2 class="text-3xl sm:text-4xl font-bold text-white mb-4">ê°œì¸ ìˆœìœ„ ì €ì¥ ì™„ë£Œ!</h2>
                <p class="text-lg sm:text-xl text-slate-300 mb-8 max-w-2xl mx-auto">
                    ì´ì œ ëª¨ë‘ ì›ë“¤ê³¼ í•¨ê»˜ í† ì˜í•˜ì—¬<br>ëª¨ë‘ ì˜ ìµœì¢… ìƒì¡´ ë¬¼í’ˆ ìˆœìœ„ë¥¼ ê²°ì •í•´ì£¼ì„¸ìš”.
                </p>
                <button id="go-to-group-ranking-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ëª¨ë‘  ìˆœìœ„ ì •í•˜ê¸° ì‹œì‘
                </button>
            </div>

            <!-- Screen 5: Group Ranking Activity -->
            <div id="group-ranking-screen" class="screen">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center flex-grow">[ëª¨ë‘ ] ìƒì¡´ ë¬¼í’ˆ ìš°ì„ ìˆœìœ„ ì •í•˜ê¸°</h2>
                     <button id="open-knowledge-modal-btn-group" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0 w-full sm:w-auto">
                        ë‚´ ì „ë¬¸ì§€ì‹ ë³´ê¸° ğŸ§ 
                    </button>
                </div>
                <div id="group-rank-list" class="w-full bg-slate-800 p-4 rounded-lg min-h-[60vh] space-y-3 max-h-[65vh] overflow-y-auto">
                   <!-- Group ranking slots will be generated here -->
                </div>
                 <div class="text-center mt-8">
                      <button id="finish-group-button" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                          ìµœì¢… ë³´ê³ ì„œ ë§Œë“¤ê¸° <span id="finish-group-button-counter">(0/15)</span>
                      </button>
                 </div>
            </div>

            <!-- Screen 6: Final Report -->
            <div id="report-screen" class="screen">
                <div id="report-content" class="p-2">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">ë‹¬ ìƒì¡´ ë³´ê³ ì„œ</h2>
                    <p class="text-center text-slate-300 mb-6">
                        ëª¨ë‘ : <span id="final-group-name" class="font-bold text-cyan-400"></span> / 
                        <span id="final-student-number" class="font-bold text-cyan-400"></span>ë²ˆ 
                        <span id="final-student-name" class="font-bold text-cyan-400"></span> / 
                        ì „ë¬¸ ë¶„ì•¼: <span id="final-role" class="font-bold text-orange-400"></span>
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Individual Report -->
                        <div class="bg-slate-900/50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-center mb-4 text-yellow-300">ë‚˜ì˜ ìƒì¡´ ê³„íš</h3>
                            <div id="individual-score-summary" class="text-center mb-4"></div>
                            <div id="individual-final-list" class="space-y-2 max-h-[45vh] overflow-y-auto bg-slate-800 p-3 rounded-md"></div>
                        </div>
                        <!-- Group Report -->
                         <div class="bg-slate-900/50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-center mb-4 text-teal-300">ìš°ë¦¬ ëª¨ë‘ ì˜ ìƒì¡´ ê³„íš</h3>
                            <div id="group-score-summary" class="text-center mb-4"></div>
                            <div id="group-final-list" class="space-y-2 max-h-[45vh] overflow-y-auto bg-slate-800 p-3 rounded-md"></div>
                        </div>
                    </div>
                </div>
                 <div class="text-center mt-6 space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="open-save-share-modal-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ê²°ê³¼ ì €ì¥í•˜ê¸°
                    </button>
                     <a href="https://pinkylucky.tistory.com/2" target="_blank" rel="noopener noreferrer" class="inline-block w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition">
                        NASA ì „ë¬¸ê°€ í•´ì„¤
                    </a>
                     <button id="restart-btn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ë‹¤ì‹œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Screen 1.5: Emergency Sequence -->
    <div id="emergency-screen" class="flex flex-col items-center justify-center p-8">
        <div id="emergency-message-container" class="text-white text-xl sm:text-2xl md:text-3xl font-bold text-center space-y-6">
            <!-- Messages will be injected here -->
        </div>
        <button id="skip-emergency-btn" class="absolute top-5 right-5 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg z-10">SKIP</button>
        <button id="proceed-to-roles-btn" class="mt-8 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hidden transition-opacity animate-pulse">
            ì „ë¬¸ ë¶„ì•¼ ì„ íƒí•˜ê¸°
        </button>
    </div>

    <!-- Modals and Global Buttons -->
    <div id="global-buttons" class="fixed bottom-5 left-5 right-5 flex justify-between items-center z-50 pointer-events-none">
        <button id="back-to-start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105 hidden pointer-events-auto">ì²˜ìŒìœ¼ë¡œ</button>
        <button id="exit-app-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105 hidden pointer-events-auto ml-auto">ì¢…ë£Œ</button>
    </div>
    
    <!-- Item Info Modal -->
    <div id="item-info-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="item-info-modal-body" class="text-white"></div>
        </div>
    </div>
    
    <!-- Item Selection Modal -->
    <div id="item-selection-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
             <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-center text-cyan-400">ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¼í’ˆ ì„ íƒ</h3>
            <div id="item-selection-modal-body" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto p-2"></div>
        </div>
    </div>

    <!-- Save/Share Modal -->
    <div id="save-share-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600 text-center">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <h3 class="text-2xl font-bold mb-6 text-cyan-400">ê²°ê³¼ ì €ì¥ ë° ê³µìœ </h3>
            <div class="flex flex-col gap-4">
                <button id="save-image-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                <button id="share-image-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">ğŸ”— ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Knowledge Modal -->
    <div id="knowledge-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="knowledge-modal-body" class="text-white"></div>
        </div>
    </div>

    <!-- General Alert/Confirm Modal -->
    <div id="alert-confirm-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600 text-center max-w-md">
            <h3 id="alert-confirm-title" class="text-xl font-bold mb-4 text-yellow-300"></h3>
            <p id="alert-confirm-message" class="text-slate-300 mb-6"></p>
            <div id="alert-confirm-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <script>
    (function() {
        let emergencySequenceTimeoutId = null;
        let activeSelectionContext = { type: null, slotIndex: null }; // 'individual' or 'group'
        
        const appData = {
            emergencyMessages: [
                "ì¹˜ì§... ì¹˜ì§€ì§...", "ì—¬ê¸°ëŠ” í†µì œì‹¤, ì‘ë‹µí•˜ë¼ ì•„ë¥´í…Œë¯¸ìŠ¤ 1í˜¸!", "ì•Œ ìˆ˜ ì—†ëŠ” ì¶©ê²©ìœ¼ë¡œ ì„ ì²´ ì†ìƒ í™•ì¸.",
                "í˜„ì¬ ìœ„ì¹˜ë¥¼ íŠ¹ì •í•  ìˆ˜ ì—†ìŒ.", "ëŒ€ì›, ë‹¹ì‹ ì˜ íŒë‹¨ì— ëª¨ë‘ì˜ ìƒì¡´ì´ ë‹¬ë ¤ìˆë‹¤.", "êµ¬ì¡°ì„ ê¹Œì§€ëŠ” ì•½ 300km.",
                "ì „ë¬¸ì§€ì‹ì„ í™œìš©í•´, 15ê°œ ë¹„ìƒ ë¬¼í’ˆì˜ ìƒì¡´ ìˆœìœ„ë¥¼ ì •í•´ë¼.", "ë°˜ë“œì‹œ... ë°˜ë“œì‹œ ì‚´ì•„ë‚¨ì•„ë¼!"
            ],
            roles: {
                scientist: { name: 'ìš°ì£¼ê³¼í•™ì', knowledge: [ { text: "ì—°ì†Œ(íƒ€ëŠ” ê²ƒ)ëŠ” ì‚°ì†Œì™€ ê°™ì€ ì‚°í™”ì œê°€ ë°˜ë“œì‹œ í•„ìš”í•´ìš”." }, { text: "ì•¡ì²´ì˜ ë“ëŠ”ì ì€ ì£¼ë³€ì˜ ê¸°ì••ì— ë”°ë¼ ë‹¬ë¼ì ¸ìš”." }, { text: "ë‹¬ì—ëŠ” ê³µê¸°ê°€ ì—†ì–´ í˜¸í¡ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, ëŒ€ê¸°ì••ì´ ê±°ì˜ 0ì— ê°€ê¹Œì›Œìš”." }, { text: "ìš°ì£¼ë³µì—ëŠ” ìì²´ì ì¸ ìƒëª… ìœ ì§€(ì‚°ì†Œ ê³µê¸‰, ì˜¨ë„ ì¡°ì ˆ) ê¸°ëŠ¥ì´ ìˆì–´ìš”." }, { text: "ë‹¬ì˜ ë¨¼ì§€ëŠ” ë§¤ìš° ê³±ê³  ë‚ ì¹´ë¡œì›Œì„œ, ê¸°ê³„ ì¥ì¹˜ì— ê³ ì¥ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆì–´ìš”." }, { text: "ìš°ì£¼ì„ ì˜ ê¸ˆì† íŒŒí¸ì€ í–‡ë¹›ì„ ë°˜ì‚¬ì‹œì¼œ ë©€ë¦¬ì„œë„ ë³´ì¼ ìˆ˜ ìˆì–´ìš”." }, { text: "ë‹¬ í‘œë©´ì˜ ì˜¨ë„ëŠ” ë‚®ì—ëŠ” 120ë„, ë°¤ì—ëŠ” -170ë„ê¹Œì§€ ë³€í•´ìš”." }, { text: "ë‹¬ì˜ 'ê³ ìš”ì˜ ë°”ë‹¤'ëŠ” ì•„í´ë¡œ 11í˜¸ê°€ ì°©ë¥™í•œ ê³³ìœ¼ë¡œ ìœ ëª…í•´ìš”." }, { text: "ì§€êµ¬ì™€ ë‹¬ ì‚¬ì´ì˜ í‰ê·  ê±°ë¦¬ëŠ” ì•½ 384,400kmì˜ˆìš”." }, { text: "ë‹¬ì˜ ê°€ì¥ í° í¬ë ˆì´í„°(ì¶©ëŒ êµ¬ë©ì´)ëŠ” ë‚¨ê·¹-ì—ì´íŠ¸ì¼„ ë¶„ì§€ì˜ˆìš”." } ] },
                explorer: { name: 'íƒí—˜ê°€', knowledge: [ { text: "ì§€êµ¬ì—ì„œ ë³¸ ë³„ìë¦¬ë“¤ì€ ë‹¬ì—ì„œë„ ë³´ì—¬ìš”. ë³„ìë¦¬ë“¤ì€ ì§€êµ¬ì™€ ë‹¬ì—ì„œ ì•„ì£¼ì•„ì£¼ ë©€ì–´ìš”." }, { text: "ìê¸°ì¥(Magnetic Field)ì€ í–‰ì„±ì˜ ë‚¨ê·¹ê³¼ ë¶ê·¹ì„ ì—°ê²°í•˜ëŠ” ê±°ëŒ€í•œ ìì„ê³¼ ê°™ì•„ìš”." }, { text: "ë‹¬ì—ëŠ” ì§€êµ¬ì™€ ê°™ì€ ìê¸°ì¥ì´ ì—†ì–´ìš”." }, { text: "300kmëŠ” ì„œìš¸ì—ì„œ ë¶€ì‚°ê¹Œì§€ì˜ ê±°ë¦¬ì™€ ë¹„ìŠ·í•˜ë©°, ê±¸ì–´ì„œ ê°€ê¸°ì—” ë§¤ìš° ë¨¼ ì—¬ì •ì´ì—ìš”." }, { text: "í–‡ë¹›ì´ ë¹„ì¹˜ëŠ” ë™ì•ˆ, ê·¸ë¦¼ìì˜ ë°©í–¥ê³¼ ê¸¸ì´ë¥¼ ì´ìš©í•´ ëŒ€ëµì ì¸ ì‹œê°„ì„ íŒŒì•…í•  ìˆ˜ ìˆì–´ìš”." }, { text: "ë‚˜ì¼ë¡  ëˆì€ ë¬´ê²Œì— ë¹„í•´ ë§¤ìš° ê°•í•œ ì¸ì¥ ê°•ë„ë¡œ ì•Œë ¤ì ¸ ìˆì–´ìš”." }, { text: "ë‹¬ í‘œë©´ì€ ë‚ ì¹´ë¡œìš´ ì•”ì„ê³¼ ë¨¼ì§€ë¡œ ë®ì—¬ ìˆì–´ ì‹ ë°œì´ë‚˜ ì¥ë¹„ê°€ ì‰½ê²Œ ì†ìƒë  ìˆ˜ ìˆì–´ìš”." }, { text: "ë‹¬ì—ëŠ” ëŒ€ê¸°ê°€ ì—†ì–´ í•˜ëŠ˜ì´ í•­ìƒ ê²€ì€ìƒ‰ì´ì—ìš”." }, { text: "ë‹¬ì—ì„œ ì²˜ìŒìœ¼ë¡œ ê³¨í”„ë¥¼ ì¹œ ìš°ì£¼ë¹„í–‰ì‚¬ê°€ ìˆì–´ìš”." }, { text: "ë‹¬ íƒì‚¬ ë¡œë²„ 'ë°”ì´í¼(VIPER)'ëŠ” ë‹¬ì˜ ë‚¨ê·¹ì—ì„œ ì–¼ìŒì„ ì°¾ëŠ” ì„ë¬´ë¥¼ ìˆ˜í–‰í•  ì˜ˆì •ì´ì—ìš”." } ] },
                communicator: { name: 'í†µì‹ ì „ë¬¸ê°€', knowledge: [ { text: "FM ì „íŒŒëŠ” ì¥ì• ë¬¼ì„ í†µê³¼í•˜ì§€ ëª»í•˜ê³  ì§ì§„í•˜ëŠ” ì„±ì§ˆì´ ê°•í•´ìš”." }, { text: "ì••ì¶•ëœ ê°€ìŠ¤ë¥¼ ë°©ì¶œí•˜ë©´, ë‰´í„´ì˜ ì œ3ë²•ì¹™(ì‘ìš©-ë°˜ì‘ìš©)ì— ë”°ë¼ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ í˜ì´ ìƒê²¨ìš”." }, { text: "ë¹›ì€ ì§„ê³µ ì†ì—ì„œë„ ì „ë‹¬ë˜ë©°, ë°˜ì§ì´ëŠ” ë¬¼ì²´ëŠ” ë©€ë¦¬ì„œë„ ì‹ë³„í•˜ê¸° ì‰¬ì›Œìš”." }, { text: "ì†Œë¦¬ëŠ” ê³µê¸° ê°™ì€ ë§¤ì§ˆì´ ìˆì–´ì•¼ ì „ë‹¬ë  ìˆ˜ ìˆì–´ìš”." }, { text: "ëª¨ìŠ¤ ë¶€í˜¸(SOS: Â·Â·Â· â€” â€” â€” Â·Â·Â·)ëŠ” ê°„ë‹¨í•œ ì‹ í˜¸ë¡œ êµ¬ì¡° ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” êµ­ì œ í‘œì¤€ì´ì—ìš”." }, { text: "íƒœì–‘ì—´ ì¶©ì „ê¸°ëŠ” í•´ê°€ ë–  ìˆëŠ” ë™ì•ˆì—ë§Œ ì‘ë™í•´ìš”." }, { text: "ìµœì´ˆì˜ ì¸ê³µìœ„ì„±ì€ ì†Œë ¨ì˜ 'ìŠ¤í‘¸íŠ¸ë‹ˆí¬ 1í˜¸'ì˜€ì–´ìš”." }, { text: "í™”ì„±íƒì‚¬ì„  'íë¦¬ì˜¤ì‹œí‹°'ëŠ” ì°©ë¥™í•  ë•Œ ìŠ¤ì¹´ì´í¬ë ˆì¸ì´ë¼ëŠ” ë…íŠ¹í•œ ë°©ë²•ì„ ì‚¬ìš©í–ˆì–´ìš”." }, { text: "ì•„í´ë¡œ ê³„íšì— ì‚¬ìš©ëœ ì»´í“¨í„°ì˜ ì²˜ë¦¬ ëŠ¥ë ¥ì€ í˜„ëŒ€ì˜ ìŠ¤ë§ˆíŠ¸í°ë³´ë‹¤ í›¨ì”¬ ë‚®ì•˜ì–´ìš”." }, { text: "ë³´ì´ì € íƒì‚¬ì„ ì—ëŠ” ì§€êµ¬ì˜ ì†Œë¦¬ì™€ ê·¸ë¦¼ì„ ë‹´ì€ 'ê³¨ë“  ë ˆì½”ë“œ'ê°€ ì‹¤ë ¤ ìˆì–´ìš”." } ] },
                medic: { name: 'ì˜ë£Œì§„', knowledge: [ { text: "NASA ìš°ì£¼ë³µì—ëŠ” ìˆ˜íŠ¸ì˜ ê¸°ë°€ì„±ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œ ì•½ë¬¼ì„ íˆ¬ì—¬í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ì£¼ì…êµ¬ê°€ ìˆì–´ìš”." }, { text: "ì¸ê°„ì€ ë¬¼ ì—†ì´ëŠ” 3ì¼ ì´ìƒ ìƒì¡´í•˜ê¸° ì–´ë ¤ì›Œìš”." }, { text: "íƒˆìˆ˜ í˜„ìƒì€ ë°©í–¥ê°ê° ìƒì‹¤ê³¼ í˜¼ë€ì„ ìœ ë°œí•  ìˆ˜ ìˆì–´ìš”." }, { text: "ìš°ì£¼ ê³µê°„ì˜ ê°•í•œ ë°©ì‚¬ì„ ì€ ì¸ì²´ì— í•´ë¡œìš°ë¯€ë¡œ, ê°€ëŠ¥í•œ í•œ ëª¸ì„ ê°€ë¦¬ëŠ” ê²ƒì´ ì¢‹ì•„ìš”." }, { text: "ìŒì‹ ë†ì¶•ì•¡ì€ ë§›ì€ ì—†ì§€ë§Œ, ì‘ì€ ì–‘ìœ¼ë¡œë„ ë†’ì€ ì¹¼ë¡œë¦¬ë¥¼ ì œê³µí•´ìš”." }, { text: "ë¶„ë§ í˜•íƒœì˜ ì‹í’ˆì€ ì„­ì·¨ë¥¼ ìœ„í•´ ì•¡ì²´ê°€ í•„ìš”í•œ ê²½ìš°ê°€ ë§ì•„ìš”." }, { text: "ìƒì²˜ê°€ ì™¸ë¶€ í™˜ê²½ì— ì§ì ‘ ë…¸ì¶œë˜ë©´ ê°ì—¼ì˜ ìœ„í—˜ì´ ì»¤ì ¸ìš”." }, { text: "ì €ì²´ì˜¨ì¦ì€ ì‹ ì²´ ê¸°ëŠ¥ ì €í•˜ì˜ ì£¼ìš” ì›ì¸ ì¤‘ í•˜ë‚˜ì˜ˆìš”." }, { text: "ìš°ì£¼ë¹„í–‰ì‚¬ë“¤ì€ ìš°ì£¼ì—ì„œ í‚¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ì•½ê°„ ì»¤ì§„ë‹¤ê³  í•´ìš”." }, { text: "ë¬´ì¤‘ë ¥ ìƒíƒœì—ì„œëŠ” ê·¼ìœ¡ê³¼ ë¼ˆê°€ ì•½í•´ì§€ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ ë§¤ì¼ 2ì‹œê°„ì”© ìš´ë™í•´ì•¼ í•´ìš”." } ] }
            },
            items: [
                { id: 15, name: 'ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒì', nasaRank: 15, icon: 'ğŸ“¦', description: 'ë§ˆì°°ì„ í†µí•´ ë¶ˆì„ ë¶™ì´ëŠ” ë„êµ¬ì¸ ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
                { id: 6, name: '15m ê¸¸ì´ì˜ ë‚˜ì¼ë¡  ëˆ', nasaRank: 6, icon: 'ğŸ§¶', description: 'ê¸¸ê³  íŠ¼íŠ¼í•œ ë‚˜ì¼ë¡  ì†Œì¬ì˜ ëˆì…ë‹ˆë‹¤.' },
                { id: 2, name: 'ë¬¼ (20L)', nasaRank: 2, icon: 'ğŸ’§', description: 'ë§ˆì‹¤ ìˆ˜ ìˆëŠ” ê¹¨ë—í•œ ë¬¼ì´ 20ë¦¬í„° ë‹´ê¸´ í†µì…ë‹ˆë‹¤.' },
                { id: 10, name: 'ì‹ í˜¸ìš© ì¡°ëª…íƒ„', nasaRank: 10, icon: 'ğŸ§¨', description: 'ë‚´ì¥ëœ ì‚°í™”ì œ ë•ë¶„ì— ì‚°ì†Œ ì—†ì´ë„ íƒ€ë©´ì„œ ë°ì€ ë¹›ì„ ë‚´ëŠ” ì‹ í˜¸ìš© í­ì£½ì…ë‹ˆë‹¤. (ì‚°í™”ì œ: ë‹¤ë¥¸ ë¬¼ì§ˆì´ ì˜ íƒ€ë„ë¡ ë•ëŠ” ë¬¼ì§ˆ)' },
                { id: 8, name: 'ë‚™í•˜ì‚° ì²œ', nasaRank: 8, icon: 'ğŸª‚', description: 'ê³µê¸° ì €í•­ì„ ì´ìš©í•˜ê¸° ìœ„í•œ í¬ê³  ì§ˆê¸´ ì²œì…ë‹ˆë‹¤.' },
                { id: 1, name: 'ì‚°ì†Œí†µ 45kg (2ì •)', nasaRank: 1, icon: 'ğŸ’¨', description: 'í˜¸í¡ì— í•„ìš”í•œ ì‚°ì†Œê°€ ì••ì¶•ë˜ì–´ ë“¤ì–´ìˆëŠ” ê¸ˆì† ìš©ê¸° 2ê°œì…ë‹ˆë‹¤.' },
                { id: 13, name: 'ë¶„ìœ  í•œ ìƒì', nasaRank: 12, icon: 'ğŸ¼', description: 'ì•„ê¸°ì—ê²Œ ì˜ì–‘ì„ ê³µê¸‰í•˜ê¸° ìœ„í•œ ë¶„ë§ í˜•íƒœì˜ ìš°ìœ ì…ë‹ˆë‹¤.' },
                { id: 5, name: 'íƒœì–‘ì—´ ì¶©ì „ì‹ FM ë¬´ì „ê¸°', nasaRank: 5, icon: 'ğŸ“»', description: 'íƒœì–‘ ë¹›ìœ¼ë¡œ ì¶©ì „í•˜ì—¬ ë‹¨ê±°ë¦¬ ì£¼íŒŒìˆ˜ ë³€ì¡°(FM) ë°©ì‹ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 12, name: 'íœ´ëŒ€ìš© ë‚œë°©ê¸°', nasaRank: 13, icon: 'ğŸ”¥', description: 'ì£¼ë³€ì„ ë”°ëœ»í•˜ê²Œ ë°ìš°ëŠ” íœ´ëŒ€ìš© ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 3, name: 'ë³„ìë¦¬ ì§€ë„', nasaRank: 3, icon: 'ğŸ—ºï¸', description: 'ì§€êµ¬ ë¶ë°˜êµ¬ì—ì„œ ë³´ì´ëŠ” ë³„ë“¤ì˜ ìœ„ì¹˜ë¥¼ í‘œì‹œí•œ ì²œì²´ ì§€ë„ì…ë‹ˆë‹¤.' },
                { id: 11, name: '45êµ¬ê²½ ê¶Œì´ 2ì •', nasaRank: 11, icon: 'ğŸ”«', description: 'ì´ì•Œì„ ë°œì‚¬í•˜ëŠ” ê°œì¸ìš© í™”ê¸° 2ì •ì…ë‹ˆë‹¤.' },
                { id: 7, name: 'êµ¬ê¸‰ ìƒì (ì£¼ì‚¬ê¸° í¬í•¨)', nasaRank: 7, icon: 'ğŸ©¹', description: 'ì†Œë…ì•½, ë¶•ëŒ€, ì˜ë£Œìš© í…Œì´í”„, ì£¼ì‚¬ê¸° ë“±ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
                { id: 4, name: 'ìŒì‹ (ìš°ì£¼ì‹)', nasaRank: 4, icon: 'ğŸ”', description: 'ë¬¼ ì—†ì´ ë°”ë¡œ ì„­ì·¨í•  ìˆ˜ ìˆë„ë¡ ë†ì¶•ëœ ë¹„ìƒ ì‹ëŸ‰ì…ë‹ˆë‹¤.' },
                { id: 14, name: 'ìì„ ë‚˜ì¹¨ë°˜', nasaRank: 14, icon: 'ğŸ§­', description: 'ì§€êµ¬ì˜ ìê¸°ì¥ì„ ì´ìš©í•˜ì—¬ ë°©í–¥ì„ ê°€ë¦¬í‚¤ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.' },
                { id: 9, name: 'êµ¬ëª… ê³ ë¬´ë³´íŠ¸', nasaRank: 9, icon: 'ğŸš¤', description: 'ë¬¼ ìœ„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³ ë¬´ ì¬ì§ˆì˜ ë³´íŠ¸ì´ë©°, ì´ì‚°í™”íƒ„ì†Œ ê°€ìŠ¤í†µìœ¼ë¡œ ë¶€í’€ë¦½ë‹ˆë‹¤.' }
            ],
            state: {}
        };

        const dom = {
            appContainer: document.getElementById('app-container'),
            rankListEl: document.getElementById('rank-list'),
            groupRankListEl: document.getElementById('group-rank-list'),
            itemInfoModalEl: document.getElementById('item-info-modal'),
            itemInfoModalBodyEl: document.getElementById('item-info-modal-body'),
            itemSelectionModalEl: document.getElementById('item-selection-modal'),
            itemSelectionModalBodyEl: document.getElementById('item-selection-modal-body'),
            saveShareModalEl: document.getElementById('save-share-modal'),
            knowledgeModalEl: document.getElementById('knowledge-modal'),
            knowledgeModalBodyEl: document.getElementById('knowledge-modal-body'),
            alertConfirmModalEl: document.getElementById('alert-confirm-modal'),
            alertConfirmTitle: document.getElementById('alert-confirm-title'),
            alertConfirmMessage: document.getElementById('alert-confirm-message'),
            alertConfirmButtons: document.getElementById('alert-confirm-buttons'),
            emergencyScreen: document.getElementById('emergency-screen'),
            emergencyMessageContainer: document.getElementById('emergency-message-container'),
            proceedToRolesBtn: document.getElementById('proceed-to-roles-btn'),
            skipEmergencyBtn: document.getElementById('skip-emergency-btn'),
            groupNameInput: document.getElementById('groupNameInput'),
            studentNumberInput: document.getElementById('studentNumberInput'),
            studentNameInput: document.getElementById('studentNameInput'),
            roleTitle: document.getElementById('role-title'),
            knowledgeList: document.getElementById('knowledge-list'),
            finishIndividualButton: document.getElementById('finish-individual-button'),
            finishIndividualButtonCounter: document.getElementById('finish-individual-button-counter'),
            finishGroupButton: document.getElementById('finish-group-button'),
            finishGroupButtonCounter: document.getElementById('finish-group-button-counter'),
            finalGroupName: document.getElementById('final-group-name'),
            finalStudentNumber: document.getElementById('final-student-number'),
            finalStudentName: document.getElementById('final-student-name'),
            finalRole: document.getElementById('final-role'),
            individualScoreSummary: document.getElementById('individual-score-summary'),
            groupScoreSummary: document.getElementById('group-score-summary'),
            individualFinalList: document.getElementById('individual-final-list'),
            groupFinalList: document.getElementById('group-final-list'),
            backToStartBtn: document.getElementById('back-to-start-btn'),
            exitAppBtn: document.getElementById('exit-app-btn'),
        };

        const SAVE_KEY = 'pinky-moon-survival-team-v1.0';
        
        const resetState = () => {
             appData.state = {
                currentScreen: 'intro-screen', groupName: '', studentName: '', studentNumber: '', selectedRole: null,
                rankedItems: Array(15).fill(null),
                groupRankedItems: Array(15).fill(null),
             };
        };

        const openModal = (modalEl) => modalEl.classList.add('show');
        const closeModal = (modalEl) => modalEl.classList.remove('show');

        const showAlert = (message, title = 'ì•Œë¦¼') => {
            dom.alertConfirmTitle.textContent = title;
            dom.alertConfirmMessage.textContent = message;
            dom.alertConfirmButtons.innerHTML = `<button class="modal-ok-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">í™•ì¸</button>`;
            openModal(dom.alertConfirmModalEl);
        };

        const showConfirm = (message, onConfirm, title = 'í™•ì¸') => {
            dom.alertConfirmTitle.textContent = title;
            dom.alertConfirmMessage.textContent = message;
            dom.alertConfirmButtons.innerHTML = `
                <button class="modal-cancel-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">ì·¨ì†Œ</button>
                <button class="modal-ok-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">í™•ì¸</button>
            `;
            openModal(dom.alertConfirmModalEl);
            dom.alertConfirmModalEl.querySelector('.modal-ok-btn').onclick = () => { closeModal(dom.alertConfirmModalEl); onConfirm(); };
        };
        
        const showEmergencySequence = () => {
            showScreen('emergency-screen');
            dom.emergencyMessageContainer.innerHTML = '';
            dom.proceedToRolesBtn.classList.add('hidden');
            dom.skipEmergencyBtn.classList.remove('hidden');

            let messageIndex = 0;
            const showNextMessage = () => {
                if (emergencySequenceTimeoutId) clearTimeout(emergencySequenceTimeoutId);
                if (messageIndex >= appData.emergencyMessages.length) {
                    dom.skipEmergencyBtn.classList.add('hidden');
                    dom.proceedToRolesBtn.classList.remove('hidden');
                    return;
                }
                const p = document.createElement('p');
                p.textContent = appData.emergencyMessages[messageIndex];
                dom.emergencyMessageContainer.appendChild(p);
                messageIndex++;
                emergencySequenceTimeoutId = setTimeout(showNextMessage, 2200);
            };
            showNextMessage();
        };
        
        const skipEmergencySequence = () => {
            if (emergencySequenceTimeoutId) clearTimeout(emergencySequenceTimeoutId);
            dom.emergencyMessageContainer.innerHTML = appData.emergencyMessages
                .map(msg => `<p style="animation: none; opacity: 1;">${msg}</p>`).join('');
            dom.skipEmergencyBtn.classList.add('hidden');
            dom.proceedToRolesBtn.classList.remove('hidden');
        };

        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            dom.emergencyScreen.style.display = 'none';

            const activeScreen = document.getElementById(screenId);
            if (screenId === 'emergency-screen') {
                dom.emergencyScreen.style.display = 'flex';
                dom.backToStartBtn.classList.add('hidden');
                dom.exitAppBtn.classList.add('hidden');
            } else if (activeScreen) {
                activeScreen.classList.add('active-screen');
                if (screenId === 'intro-screen') {
                    dom.backToStartBtn.classList.add('hidden');
                    dom.exitAppBtn.classList.add('hidden');
                } else {
                    dom.backToStartBtn.classList.remove('hidden');
                    dom.exitAppBtn.classList.remove('hidden');
                }
            }
            appData.state.currentScreen = screenId;
            if (screenId !== 'intro-screen' && screenId !== 'emergency-screen') autoSave();
        };

        const startMission = () => {
            appData.state.groupName = dom.groupNameInput.value.trim();
            appData.state.studentName = dom.studentNameInput.value.trim();
            appData.state.studentNumber = dom.studentNumberInput.value;
            if (!appData.state.groupName || !appData.state.studentName || !appData.state.studentNumber) {
                showAlert('ëª¨ë‘  ì´ë¦„, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥(ì„ íƒ)í•´ì£¼ì„¸ìš”!');
                return;
            }
            saveState();
            showEmergencySequence();
        };

        const selectRole = (roleId) => {
            appData.state.selectedRole = roleId;
            const role = appData.roles[roleId];
            dom.roleTitle.innerText = `[${role.name}]`;
            dom.knowledgeList.innerHTML = ''; 

            const roleKnowledgeTitle = document.createElement('h4');
            roleKnowledgeTitle.className = "text-lg font-bold text-orange-300 mt-4 md:col-span-2";
            roleKnowledgeTitle.textContent = "ğŸš€ ì „ë¬¸ ì§€ì‹";
            dom.knowledgeList.appendChild(roleKnowledgeTitle);

            role.knowledge.forEach(fact => {
                const li = document.createElement('div');
                li.className = "bg-slate-700 p-3 rounded";
                li.textContent = `- ${fact.text}`;
                dom.knowledgeList.appendChild(li);
            });

            const separator = document.createElement('hr');
            separator.className = "border-slate-600 my-4 md:col-span-2";
            dom.knowledgeList.appendChild(separator);

            const itemInfoTitle = document.createElement('h4');
            itemInfoTitle.className = "text-lg font-bold text-cyan-300 md:col-span-2";
            itemInfoTitle.textContent = "ğŸ’ ë¬¼í’ˆ ì •ë³´";
            dom.knowledgeList.appendChild(itemInfoTitle);

            appData.items.forEach(item => {
                const itemInfoEl = document.createElement('div');
                itemInfoEl.className = "bg-slate-700 p-3 rounded";
                itemInfoEl.innerHTML = `<p class="font-bold">${item.icon} ${item.name}</p><p class="text-sm text-slate-400 mt-1">${item.description}</p>`;
                dom.knowledgeList.appendChild(itemInfoEl);
            });

            showScreen('knowledge-screen');
        };
        
        const updateFinishButtonState = (type) => {
            const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
            const button = type === 'individual' ? dom.finishIndividualButton : dom.finishGroupButton;
            const counter = type === 'individual' ? dom.finishIndividualButtonCounter : dom.finishGroupButtonCounter;
            
            const itemCount = rankedItems.filter(item => item !== null).length;
            counter.textContent = `(${itemCount}/15)`;
            button.disabled = (itemCount !== 15);
        };
        
        const renderRankingSlots = (type) => {
            const listEl = type === 'individual' ? dom.rankListEl : dom.groupRankListEl;
            const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
            const reasonAttribute = type === 'individual' ? 'data-reason-for-item' : 'data-reason-for-group-item';

            listEl.innerHTML = '';
            rankedItems.forEach((itemData, index) => {
                const slotEl = document.createElement('div');
                slotEl.dataset.slotIndex = index;
                slotEl.dataset.rankType = type;

                if (itemData) {
                    const item = appData.items.find(i => i.id === itemData.id);
                    slotEl.className = 'rank-slot filled bg-slate-700 p-3 rounded-md';
                    slotEl.dataset.itemId = item.id;
                    slotEl.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <span class="drag-handle">â ¿</span>
                            <div class="flex-1 min-w-0 font-bold text-lg text-orange-400 flex items-center pointer-events-none">
                                <span class="rank-number mr-2">${index + 1}ìœ„.</span>
                                <span>${item.icon} ${item.name}</span>
                            </div>
                            <button data-info-id="${item.id}" class="text-xs bg-sky-600 hover:bg-sky-500 text-white py-1 px-2 rounded ml-auto flex-shrink-0">ì •ë³´</button>
                            <button data-clear-slot="${index}" data-clear-type="${type}" class="text-xs bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded flex-shrink-0">X</button>
                        </div>
                        <textarea ${reasonAttribute}="${item.id}" class="w-full bg-slate-900 text-white rounded p-2 text-sm" rows="2" placeholder="ì´ ë¬¼í’ˆì„ ì´ ìˆœìœ„ë¡œ ì •í•œ ì´ìœ ëŠ”...">${itemData.reason || ''}</textarea>
                    `;
                } else {
                    slotEl.className = 'rank-slot empty bg-slate-900/50 p-3 rounded-md border-2 border-slate-700 flex items-center justify-center h-24 transition';
                    slotEl.innerHTML = `<div class="text-center text-slate-500"><span class="font-bold text-xl">${index + 1}ìœ„</span><p class="text-sm">í´ë¦­í•˜ì—¬ ë¬¼í’ˆ ì„ íƒ</p></div>`;
                }
                listEl.appendChild(slotEl);
            });
            updateFinishButtonState(type);
        };
        
        const openItemSelectionModal = (slotIndex, type) => {
            activeSelectionContext = { type, slotIndex };
            const rankedItemIds = new Set( (type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems).filter(Boolean).map(item => item.id) );
            const availableItems = appData.items.filter(item => !rankedItemIds.has(item.id));
            
            dom.itemSelectionModalBodyEl.innerHTML = '';
            if (availableItems.length === 0) {
                dom.itemSelectionModalBodyEl.innerHTML = `<p class="text-center text-slate-400 col-span-full">ëª¨ë“  ë¬¼í’ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
            } else {
                availableItems.forEach(item => {
                    const itemEl = document.createElement('button');
                    itemEl.className = 'p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-left transition';
                    itemEl.dataset.itemId = item.id;
                    itemEl.innerHTML = `<p class="font-bold text-lg">${item.icon} ${item.name}</p>`;
                    itemEl.onclick = () => {
                        const rankedItems = activeSelectionContext.type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                        rankedItems[activeSelectionContext.slotIndex] = { id: item.id, reason: '' };
                        closeModal(dom.itemSelectionModalEl);
                        renderRankingSlots(activeSelectionContext.type);
                        autoSave();
                    };
                    dom.itemSelectionModalBodyEl.appendChild(itemEl);
                });
            }
            openModal(dom.itemSelectionModalEl);
        };

        const finishIndividualRanking = () => {
            showScreen('transition-screen');
        };

        const generateReport = () => {
            dom.finalGroupName.textContent = appData.state.groupName;
            dom.finalStudentName.textContent = appData.state.studentName;
            dom.finalStudentNumber.textContent = appData.state.studentNumber;
            dom.finalRole.textContent = appData.roles[appData.state.selectedRole].name;
            
            const calculateScoreAndRenderList = (type) => {
                const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                const listEl = type === 'individual' ? dom.individualFinalList : dom.groupFinalList;
                const summaryEl = type === 'individual' ? dom.individualScoreSummary : dom.groupScoreSummary;
                
                listEl.innerHTML = '';
                let totalScore = 0;
                
                rankedItems.forEach((itemData, index) => {
                    const item = appData.items.find(i => i.id === itemData.id);
                    const userRank = index + 1;
                    const nasaRank = item.nasaRank;
                    totalScore += Math.abs(userRank - nasaRank);

                    const reportItem = document.createElement('div');
                    reportItem.className = 'p-2 bg-slate-900 rounded-md text-sm';
                    reportItem.innerHTML = `
                        <p class="font-bold">${userRank}ìœ„. ${item.icon} ${item.name}</p>
                        <p class="text-slate-400 mt-1 pl-3">ì´ìœ : ${itemData.reason || 'ì‘ì„±í•˜ì§€ ì•ŠìŒ'}</p>
                    `;
                    listEl.appendChild(reportItem);
                });

                let evaluation = '', eng_eval = '';
                if (totalScore <= 25) { evaluation = 'NASAì—ì„œ ì—°ë½ì˜µë‹ˆë‹¤. ë‹¹ì‹ ì€ ì™¸ê³„ì¸ì¸ê°€ìš”?'; eng_eval = 'Excellent';}
                else if (totalScore <= 32) { evaluation = 'ë‹¬ ë¶€ë™ì‚° íˆ¬ì ì¶”ì²œ! ë‹¹ì‹ ì€ ì´ë¯¸ ë‹¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.'; eng_eval = 'Good';}
                else if (totalScore <= 45) { evaluation = 'ì•„ìŠ¬ì•„ìŠ¬... ì§€êµ¬ì— ê°ˆ ìˆ˜ ìˆê² ì£ ?'; eng_eval = 'Average';}
                else if (totalScore <= 55) { evaluation = 'ì§€êµ¬ì— ìˆëŠ” ê°€ì¡±... ìƒê°ë‚˜ì‹œë‚˜ìš”?'; eng_eval = 'Fair';}
                else if (totalScore <= 70) { evaluation = 'í˜¹ì‹œ í•˜ê³  ì‹¶ì€ ë§ì´ ìˆë‚˜ìš”?'; eng_eval = 'Danger';}
                else { evaluation = 'ê·¸ë™ì•ˆ í•¨ê»˜í•´ì„œ í–‰ë³µí–ˆì–´ìš”.'; eng_eval = 'U dead';}
                
                summaryEl.innerHTML = `
                    <p class="text-lg font-bold">ì´ì : <span class="text-red-400">${totalScore}ì </span></p>
                    <p class="text-lg font-bold mt-1">"${evaluation}"</p>
                `;
            };

            calculateScoreAndRenderList('individual');
            calculateScoreAndRenderList('group');
            
            showScreen('report-screen');
        };
        
        const openKnowledgeModal = () => {
            if (!appData.state.selectedRole) return;
            const role = appData.roles[appData.state.selectedRole];
            dom.knowledgeModalBodyEl.innerHTML = '';

            const mainTitle = document.createElement('h3');
            mainTitle.className = "text-2xl font-bold mb-4 text-center";
            mainTitle.textContent = "ì •ë³´ ë‹¤ì‹œë³´ê¸°";
            dom.knowledgeModalBodyEl.appendChild(mainTitle);
            
            const scrollContainer = document.createElement('div');
            scrollContainer.className = "max-h-[60vh] overflow-y-auto p-2 space-y-4";
            
            const roleSection = document.createElement('div');
            const roleTitle = document.createElement('h4');
            roleTitle.className = "text-lg font-bold text-orange-300 mb-2";
            roleTitle.textContent = `ğŸš€ [${role.name}] ì „ë¬¸ ì§€ì‹`;
            roleSection.appendChild(roleTitle);

            const roleList = document.createElement('ul');
            roleList.className = "list-disc list-inside space-y-1 text-slate-300";
            role.knowledge.forEach(fact => {
                const li = document.createElement('li');
                li.textContent = fact.text;
                roleList.appendChild(li);
            });
            roleSection.appendChild(roleList);
            scrollContainer.appendChild(roleSection);

            const separator = document.createElement('hr');
            separator.className = "border-slate-600 my-4";
            scrollContainer.appendChild(separator);

            const itemSection = document.createElement('div');
            const itemTitle = document.createElement('h4');
            itemTitle.className = "text-lg font-bold text-cyan-300 mb-2";
            itemTitle.textContent = "ğŸ’ ë¬¼í’ˆ ì •ë³´";
            itemSection.appendChild(itemTitle);
            const itemListContainer = document.createElement('div');
            itemListContainer.className = "space-y-3";
            appData.items.forEach(item => {
                const itemInfoEl = document.createElement('div');
                itemInfoEl.className = "bg-slate-900 p-3 rounded";
                itemInfoEl.innerHTML = `<p class="font-bold">${item.icon} ${item.name}</p><p class="text-sm text-slate-400 mt-1">${item.description}</p>`;
                itemListContainer.appendChild(itemInfoEl);
            });
            itemSection.appendChild(itemListContainer);
            scrollContainer.appendChild(itemSection);
            
            dom.knowledgeModalBodyEl.appendChild(scrollContainer);
            openModal(dom.knowledgeModalEl);
        };
        
        const generateReportCanvas = () => {
            const reportContent = document.getElementById('report-content');
            
            // Temporarily disable overflow for full capture
            const individualList = document.getElementById('individual-final-list');
            const groupList = document.getElementById('group-final-list');
            const oldIndividualHeight = individualList.style.maxHeight;
            const oldGroupHeight = groupList.style.maxHeight;
            individualList.style.maxHeight = 'none';
            groupList.style.maxHeight = 'none';

            return new Promise((resolve) => {
                html2canvas(reportContent, { 
                    backgroundColor: "#172a46",
                    onclone: (doc) => { doc.getElementById('report-content').style.color = '#e6f1ff'; }
                }).then(canvas => {
                    // Restore original styles
                    individualList.style.maxHeight = oldIndividualHeight;
                    groupList.style.maxHeight = oldGroupHeight;
                    resolve(canvas);
                });
            });
        };
        
        const downloadReport = () => {
             generateReportCanvas().then(canvas => {
                const link = document.createElement('a');
                const groupName = appData.state.groupName || 'ì†Œì†ì—†ìŒ';
                const studentNumber = appData.state.studentNumber || '00';
                const studentName = appData.state.studentName || 'ì´ë¦„ì—†ìŒ';
                link.download = `ë‹¬ìƒì¡´_${groupName}_${studentNumber}ë²ˆ_${studentName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        };

        const shareReport = async () => {
            try {
                const canvas = await generateReportCanvas();
                canvas.toBlob(async (blob) => {
                    const groupName = appData.state.groupName || 'ì†Œì†ì—†ìŒ';
                    const studentNumber = appData.state.studentNumber || '00';
                    const studentName = appData.state.studentName || 'ì´ë¦„ì—†ìŒ';
                    const fileName = `ë‹¬ìƒì¡´_${groupName}_${studentNumber}ë²ˆ_${studentName}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'ë‚˜ì˜ ë‹¬ ìƒì¡´ ë³´ê³ ì„œ',
                            text: 'ë‹¬ì—ì„œ ì‚´ì•„ë‚¨ê¸°! ìš°ë¦¬ ëª¨ë‘ ì˜ ì ìˆ˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!',
                        });
                    } else {
                        showAlert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'ì•Œë¦¼');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('ê³µìœ  ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
                showAlert('ì´ë¯¸ì§€ë¥¼ ê³µìœ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
            }
        };

        const restart = () => { localStorage.removeItem(SAVE_KEY); window.location.reload(); };

        const saveState = () => {
            try {
                if (appData.state.currentScreen === 'intro-screen' || appData.state.currentScreen === 'emergency-screen') return;

                const saveReasons = (type) => {
                    const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                    const listEl = type === 'individual' ? dom.rankListEl : dom.groupRankListEl;
                    const reasonAttribute = type === 'individual' ? 'data-reason-for-item' : 'data-reason-for-group-item';

                    rankedItems.forEach((itemData, index) => {
                        if (itemData) {
                            const textarea = listEl.querySelector(`textarea[${reasonAttribute}="${itemData.id}"]`);
                            if (textarea) rankedItems[index].reason = textarea.value;
                        }
                    });
                };
                
                if(appData.state.currentScreen === 'main-screen') saveReasons('individual');
                if(appData.state.currentScreen === 'group-ranking-screen') saveReasons('group');

                localStorage.setItem(SAVE_KEY, JSON.stringify({ ...appData.state, version: 'team-1.0' }));
            } catch (e) { console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", e); }
        };
        const autoSave = () => saveState();

        const restoreSession = () => {
            try {
                const savedStateJSON = localStorage.getItem(SAVE_KEY);
                if (!savedStateJSON) return false;
                const savedState = JSON.parse(savedStateJSON);

                appData.state = savedState;
                dom.groupNameInput.value = appData.state.groupName || '';
                dom.studentNumberInput.value = appData.state.studentNumber || '';
                dom.studentNameInput.value = appData.state.studentName || '';

                const screenToRestore = appData.state.currentScreen === 'emergency-screen' ? 'role-screen' : appData.state.currentScreen;
                showScreen(screenToRestore || 'intro-screen');

                if (screenToRestore === 'main-screen') renderRankingSlots('individual');
                if (screenToRestore === 'group-ranking-screen') renderRankingSlots('group');
                if (screenToRestore === 'report-screen') generateReport();

                return true;
            } catch (e) {
                localStorage.removeItem(SAVE_KEY);
                return false;
            }
        };
        
        const initialize = () => {
            for (let i = 1; i <= 40; i++) {
                const opt = document.createElement('option');
                opt.value = String(i).padStart(2, '0');
                opt.textContent = `${i}ë²ˆ`;
                dom.studentNumberInput.appendChild(opt);
            }

            document.body.addEventListener('click', (event) => {
                const target = event.target;
                const roleCard = target.closest('.role-card');
                const emptySlot = target.closest('.rank-slot.empty');
                const infoButton = target.closest('[data-info-id]');
                const clearButton = target.closest('[data-clear-slot]');

                if (target.id === 'start-mission-btn') startMission();
                else if (target.id === 'skip-emergency-btn') skipEmergencySequence();
                else if (target.id === 'proceed-to-roles-btn') showScreen('role-screen');
                else if (roleCard) selectRole(roleCard.dataset.role);
                else if (target.id === 'go-to-ranking-btn') { showScreen('main-screen'); renderRankingSlots('individual'); }
                else if (target.id === 'finish-individual-button') finishIndividualRanking();
                else if (target.id === 'go-to-group-ranking-btn') { showScreen('group-ranking-screen'); renderRankingSlots('group'); }
                else if (target.id === 'finish-group-button') generateReport();
                else if (target.id === 'open-knowledge-modal-btn' || target.id === 'open-knowledge-modal-btn-group') openKnowledgeModal();
                else if (target.id === 'back-to-start-btn') showConfirm('ì§€ê¸ˆê¹Œì§€ì˜ ì§„í–‰ ìƒí™©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', restart, 'ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°');
                else if (target.id === 'exit-app-btn') showConfirm('ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì€ ì €ì¥ë©ë‹ˆë‹¤.', () => { window.close(); }, 'ì¢…ë£Œ');
                else if (target.id === 'restart-btn') showConfirm('ì •ë§ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', restart, 'ë‹¤ì‹œ ì‹œì‘í•˜ê¸°');
                else if (target.id === 'open-save-share-modal-btn') openModal(dom.saveShareModalEl);
                else if (target.id === 'save-image-btn') { closeModal(dom.saveShareModalEl); downloadReport(); }
                else if (target.id === 'share-image-btn') { closeModal(dom.saveShareModalEl); shareReport(); }
                else if (target.closest('.close-modal-btn') || (target.classList.contains('modal-base') && !target.querySelector('.modal-content'))) closeModal(target.closest('.modal-base'));
                else if(target.closest('.modal-ok-btn') || target.closest('.modal-cancel-btn')) closeModal(target.closest('.modal-base'));
                else if (emptySlot) openItemSelectionModal(parseInt(emptySlot.dataset.slotIndex, 10), emptySlot.dataset.rankType);
                else if (infoButton) {
                    const item = appData.items.find(i => i.id == infoButton.dataset.infoId);
                    if (item) {
                        dom.itemInfoModalBodyEl.innerHTML = `<h3 class="text-2xl font-bold mb-4">${item.icon} ${item.name}</h3><p>${item.description || 'ì •ë³´ ì—†ìŒ'}</p>`;
                        openModal(dom.itemInfoModalEl);
                    }
                } else if (clearButton) {
                    const slotIndex = parseInt(clearButton.dataset.clearSlot, 10);
                    const type = clearButton.dataset.clearType;
                    const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                    rankedItems[slotIndex] = null;
                    renderRankingSlots(type);
                    autoSave();
                }
            });

            ['groupNameInput', 'studentNameInput', 'studentNumberInput'].forEach(id => {
                dom[id].addEventListener('input', () => { appData.state[id.replace('Input','')] = dom[id].value; autoSave(); });
            });
            dom.rankListEl.addEventListener('input', (e) => { if(e.target.matches('textarea')) autoSave(); });
            dom.groupRankListEl.addEventListener('input', (e) => { if(e.target.matches('textarea')) autoSave(); });

            new Sortable(dom.rankListEl, {
                animation: 150, handle: '.drag-handle',
                onEnd: (evt) => {
                    const itemData = appData.state.rankedItems.splice(evt.oldIndex, 1)[0];
                    appData.state.rankedItems.splice(evt.newIndex, 0, itemData);
                    renderRankingSlots('individual');
                    autoSave();
                }
            });
            new Sortable(dom.groupRankListEl, {
                animation: 150, handle: '.drag-handle',
                onEnd: (evt) => {
                    const itemData = appData.state.groupRankedItems.splice(evt.oldIndex, 1)[0];
                    appData.state.groupRankedItems.splice(evt.newIndex, 0, itemData);
                    renderRankingSlots('group');
                    autoSave();
                }
            });
            
            if(!restoreSession()) {
                resetState();
            }
            
            showScreen(appData.state.currentScreen || 'intro-screen');

            setInterval(saveState, 30000);
            window.addEventListener('beforeunload', saveState);
            document.addEventListener('visibilitychange', () => { if (document.hidden) saveState(); });
        };
        
        initialize();
    })();
    </script>
</body>
</html>
