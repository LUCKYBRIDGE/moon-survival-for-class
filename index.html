<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë‹¬ ì¡°ë‚œ ìƒí™© ìƒì¡´ ì‹œë®¬ë ˆì´ì…˜ (ëª¨ë‘  í™œë™ìš©)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!--
        Copyright (c) 2025 [Pinky]
        This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
        You should have received a copy of the license along with this work. If not, see <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #0a192f;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: #e6f1ff;
        }
        #app-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .screen { display: none; }
        .active-screen { display: block; }
        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: #94a3b8;
        }
        .drag-handle:hover {
            color: #e2e8f0;
        }
        .sortable-ghost {
            background: #4a5568;
            opacity: 0.5;
        }
        .modal-base {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0s 0.2s;
        }
        .modal-base.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease;
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 2rem;
            width: 95%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        .modal-base.show .modal-content {
            transform: scale(1);
        }
        #emergency-screen {
            background-color: #000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 200;
        }
        #emergency-message-container p {
            opacity: 0;
            animation: fadeIn 1.5s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .rank-slot.empty {
            cursor: pointer;
            border-style: dashed;
        }
        .rank-slot.empty:hover {
            background-color: #334155; /* slate-700 */
        }
        /* ë‹¨ì–´ ì˜ë¦¼ ë°©ì§€ ìŠ¤íƒ€ì¼ */
        .keep-all {
            word-break: keep-all;
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <!-- Fullscreen Button -->
    <button id="fullscreen-btn" class="fixed top-4 right-4 z-50 p-2 bg-slate-700/50 hover:bg-slate-600/70 rounded-full text-white transition">
        <svg id="fs-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"/><path d="M3 16.2V21m0 0h4.8M3 21l6-6"/><path d="M21 7.8V3m0 0h-4.8M21 3l-6 6"/><path d="M3 7.8V3m0 0h4.8M3 3l6 6"/></svg>
        <svg id="fs-exit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="m15 15 6 6m-6-6v4.8m0-4.8h4.8"/><path d="M9 16.2V21m0 0H4.2M9 21l-6-6"/><path d="M15 7.8V3m0 0h4.8M15 3l6 6"/><path d="M9 7.8V3m0 0H4.2M9 3l-6 6"/></svg>
    </button>

    <div id="app-wrapper">
        <div id="app-container" class="w-full max-w-7xl mx-auto bg-[#172a46] bg-opacity-80 backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8">

            <!-- Screen 0: Welcome Screen -->
            <div id="welcome-screen" class="screen active-screen text-center">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-6">ë‹¬ì—ì„œ ê¸¸ì„ ìƒë‹¤</h1>
                <p class="text-lg sm:text-xl text-slate-300 mb-8 max-w-3xl mx-auto keep-all">
                    ë‹¬ì—ì„œ ì‚´ì•„ë‚¨ê¸° ìœ„í•œ ëª¨ë‘  í˜‘ë™ í•™ìŠµì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.
                </p>

                <div class="max-w-3xl mx-auto text-left bg-slate-800/50 p-6 rounded-lg mb-8 space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-cyan-300 mb-3">ìˆ˜ì—… ëª©í‘œ</h2>
                        <p class="keep-all text-slate-300">
                            ì£¼ì–´ì§„ ì •ë³´(ì „ë¬¸ ì§€ì‹)ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•©ë¦¬ì ì¸ ì˜ì‚¬ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê³¼ì •ì„ ì²´í—˜í•˜ê³ , ëª¨ë‘ ì›ê³¼ì˜ í† ì˜ë¥¼ í†µí•´ ìµœì„ ì˜ ê²°ê³¼ë¥¼ ë„ì¶œí•˜ëŠ” í˜‘ì—… ëŠ¥ë ¥ì„ ê¸°ë¦…ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-cyan-300 mb-3">ìˆ˜ì—… í™œë™ ì•ˆë‚´</h2>
                        <div class="space-y-3 text-slate-300">
                            <p class="keep-all"><b>[í™œë™ 1] ê°œì¸ë³„ ì˜ê²¬ ë§ˆë ¨:</b> ëª¨ë‘ ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ê°ì ì–»ì€ ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì¡´ì— í•„ìš”í•œ ë¬¼í’ˆ ìˆœìœ„ë¥¼ ì •í•©ë‹ˆë‹¤.</p>
                            <p class="keep-all"><b>[í™œë™ 2] ëª¨ë‘ ë³„ ì˜ê²¬ ì¡°ìœ¨:</b> ëª¨ë‘ ì›ë“¤ê³¼ ê°ìì˜ ìˆœìœ„ì™€ ê·¼ê±°ë¥¼ ê³µìœ í•˜ë©° í† ì˜í•©ë‹ˆë‹¤. í† ì˜ë¥¼ í†µí•´ ìš°ë¦¬ ëª¨ë‘ ì˜ ìµœì¢… ìˆœìœ„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.</p>
                            <p class="keep-all"><b>[ê²°ê³¼ í™•ì¸]</b> ê°œì¸ ìˆœìœ„ì™€ ëª¨ë‘  ìˆœìœ„ë¥¼ NASA ì „ë¬¸ê°€ì˜ ë‹µê³¼ ë¹„êµí•˜ë©°, ë” ë‚˜ì€ ì˜ì‚¬ê²°ì • ê³¼ì •ì„ ë˜ëŒì•„ë´…ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-yellow-300 mb-2">ê¼­ ì½ì–´ì£¼ì„¸ìš”!</h3>
                        <p class="text-slate-400 keep-all">ëª¨ë‘ ì›ì€ ê°ì ë‹¤ë¥¸ ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•´ì•¼ í˜‘ë™ì˜ íš¨ê³¼ê°€ ì»¤ì§‘ë‹ˆë‹¤. ìì‹ ì˜ ì˜ê²¬ë§Œ ê³ ì§‘í•˜ê¸°ë³´ë‹¤, ë‹¤ë¥¸ ëª¨ë‘ ì›ì˜ ì „ë¬¸ ì§€ì‹ì„ ì¡´ì¤‘í•˜ê³  ê²½ì²­í•˜ë©° í•©ë¦¬ì ì¸ ê²°ì •ì„ ë‚´ë ¤ë³´ì„¸ìš”.</p>
                    </div>
                </div>

                <button id="start-class-btn" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ìˆ˜ì—… ì‹œì‘í•˜ê¸°
                </button>

                <div class="mt-8 border-t border-slate-700 pt-6">
                     <p class="text-slate-400 mb-2">â€» ì´ í™œë™ì€ ëª¨ë‘  ìˆ˜ì—…ìš©ì…ë‹ˆë‹¤.</p>
                    <a href="https://moon-survival.pages.dev/" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:text-sky-300 underline">
                        ê°œì¸ í™œë™ ë²„ì „ìœ¼ë¡œ ì²´í—˜í•˜ê¸°
                    </a>
                </div>
            </div>

            <!-- Screen 1: Setup Screen -->
            <div id="setup-screen" class="screen text-center">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-4">ëª¨ë‘  ì •ë³´ ì…ë ¥</h1>
                 <p class="text-base sm:text-lg md:text-xl text-slate-300 mb-8 max-w-3xl mx-auto keep-all">
                    ëª¨ë‘ ê³¼ ë‹¹ì‹ ì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </p>
                <div class="max-w-sm mx-auto mb-8 space-y-4">
                    <div>
                        <label for="groupNameInput" class="block mb-2 text-sm font-medium text-slate-300">ëª¨ë‘  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                        <input type="text" id="groupNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) 1ëª¨ë‘ , AíŒ€" required>
                    </div>
                    <div>
                        <label for="studentNumberInput" class="block mb-2 text-sm font-medium text-slate-300">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
                        <select id="studentNumberInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" required>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="studentNameInput" class="block mb-2 text-sm font-medium text-slate-300">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                        <input type="text" id="studentNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) í™ê¸¸ë™" required>
                    </div>
                </div>
                <button id="start-mission-btn" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ë¯¸ì…˜ ì‹œì‘
                </button>
            </div>
            
            <!-- Screen 2: Role Selection -->
            <div id="role-screen" class="screen">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6">ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <p class="text-center text-slate-300 mb-8 keep-all">ì„ íƒí•œ ì—­í• ì— ë”°ë¼ íŠ¹ë³„í•œ ì „ë¬¸ ì§€ì‹ì„ ì–»ê²Œ ë©ë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div data-role="scientist" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ”¬</div>
                        <h3 class="text-xl sm:text-2xl font-bold">ìš°ì£¼ê³¼í•™ì</h3>
                        <p class="text-slate-400 text-sm sm:text-base keep-all">ë‹¬ì˜ í™˜ê²½ê³¼ ë¬¼ë¦¬ ë²•ì¹™ì— ëŒ€í•´ ê¹Šì´ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="explorer" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ§­</div>
                        <h3 class="text-xl sm:text-2xl font-bold">íƒí—˜ê°€</h3>
                        <p class="text-slate-400 text-sm sm:text-base keep-all">í—˜ë‚œí•œ ì§€í˜•ì„ ëŒíŒŒí•˜ê³  ê¸¸ì„ ì°¾ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="communicator" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ“¡</div>
                        <h3 class="text-xl sm:text-2xl font-bold">í†µì‹ ì „ë¬¸ê°€</h3>
                        <p class="text-slate-400 text-sm sm:text-base keep-all">ì¥ë¹„ë¥¼ í™œìš©í•´ êµ¬ì¡° ì‹ í˜¸ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div data-role="medic" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                        <div class="text-5xl sm:text-6xl mb-4">ğŸ©º</div>
                        <h3 class="text-xl sm:text-2xl font-bold">ì˜ë£Œì§„</h3>
                        <p class="text-slate-400 text-sm sm:text-base keep-all">ê·¹í•œ ìƒí™©ì—ì„œ ìƒëª…ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            
            <!-- Screen 3: Knowledge Briefing -->
            <div id="knowledge-screen" class="screen">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-2">ì „ë¬¸ ì§€ì‹ ë¸Œë¦¬í•‘</h2>
                <p id="role-title" class="text-center text-orange-400 font-bold text-lg mb-6"></p>
                <div id="knowledge-list" class="bg-slate-800 p-4 sm:p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4 text-slate-300 max-h-[65vh] overflow-y-auto">
                    <!-- Knowledge items will be injected here by JS -->
                </div>
                <div class="text-center mt-8">
                    <button id="go-to-ranking-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ë‚´ ìˆœìœ„ ì •í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- Screen 4: Main Ranking Activity (Individual) -->
            <div id="main-screen" class="screen">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center flex-grow">[ê°œì¸] ìƒì¡´ ë¬¼í’ˆ ìš°ì„ ìˆœìœ„ ì •í•˜ê¸°</h2>
                    <button id="open-knowledge-modal-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0 w-full sm:w-auto">
                        ë‚´ ì „ë¬¸ì§€ì‹ ë³´ê¸° ğŸ§ 
                    </button>
                </div>
                <div id="rank-list" class="w-full bg-slate-800 p-4 rounded-lg min-h-[60vh] space-y-3 max-h-[65vh] overflow-y-auto">
                   <!-- Ranking slots will be generated here -->
                </div>
                 <div class="text-center mt-8">
                      <button id="finish-individual-button" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                          ê°œì¸ ìˆœìœ„ ì œì¶œí•˜ê¸° <span id="finish-individual-button-counter">(0/15)</span>
                      </button>
                 </div>
            </div>
            
            <!-- Screen 5: Group Ranking Activity -->
            <div id="group-ranking-screen" class="screen">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center flex-grow">[ëª¨ë‘ ] ìƒì¡´ ë¬¼í’ˆ ìš°ì„ ìˆœìœ„ ì •í•˜ê¸°</h2>
                     <button id="open-knowledge-modal-btn-group" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0 w-full sm:w-auto">
                        ë‚´ ì „ë¬¸ì§€ì‹ ë³´ê¸° ğŸ§ 
                    </button>
                </div>
                <div id="group-rank-list" class="w-full bg-slate-800 p-4 rounded-lg min-h-[60vh] space-y-3 max-h-[65vh] overflow-y-auto">
                   <!-- Group ranking slots will be generated here -->
                </div>
                 <div class="text-center mt-8">
                      <button id="finish-group-button" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                          ìµœì¢… ë³´ê³ ì„œ ë§Œë“¤ê¸° <span id="finish-group-button-counter">(0/15)</span>
                      </button>
                 </div>
            </div>

            <!-- Screen 6: Final Report -->
            <div id="report-screen" class="screen">
                <div id="report-content" class="p-2">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">ë‹¬ ìƒì¡´ ë³´ê³ ì„œ</h2>
                    <p class="text-center text-slate-300 mb-6">
                        ëª¨ë‘ : <span id="final-group-name" class="font-bold text-cyan-400"></span> / 
                        <span id="final-student-number" class="font-bold text-cyan-400"></span>ë²ˆ 
                        <span id="final-student-name" class="font-bold text-cyan-400"></span> / 
                        ì „ë¬¸ ë¶„ì•¼: <span id="final-role" class="font-bold text-orange-400"></span>
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Individual Report -->
                        <div class="bg-slate-900/50 p-4 rounded-lg flex flex-col">
                            <h3 class="text-xl font-bold text-center mb-4 text-yellow-300">ë‚˜ì˜ ìƒì¡´ ê³„íš</h3>
                            <div id="individual-score-summary" class="text-center mb-4"></div>
                            <div id="individual-final-list" class="space-y-2 flex-grow overflow-y-auto bg-slate-800 p-3 rounded-md max-h-[50vh] lg:max-h-[45vh]"></div>
                        </div>
                        <!-- Group Report -->
                         <div class="bg-slate-900/50 p-4 rounded-lg flex flex-col">
                            <h3 class="text-xl font-bold text-center mb-4 text-teal-300">ìš°ë¦¬ ëª¨ë‘ ì˜ ìƒì¡´ ê³„íš</h3>
                            <div id="group-score-summary" class="text-center mb-4"></div>
                            <div id="group-final-list" class="space-y-2 flex-grow overflow-y-auto bg-slate-800 p-3 rounded-md max-h-[50vh] lg:max-h-[45vh]"></div>
                        </div>
                    </div>
                </div>
                 <div class="text-center mt-6 space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="open-save-share-modal-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ê²°ê³¼ ì €ì¥í•˜ê¸°
                    </button>
                     <a href="https://pinkylucky.tistory.com/2" target="_blank" rel="noopener noreferrer" class="inline-block w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition">
                        NASA ì „ë¬¸ê°€ í•´ì„¤
                    </a>
                     <button id="restart-btn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                        ë‹¤ì‹œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Screen 1.5: Emergency Sequence -->
    <div id="emergency-screen" class="flex flex-col items-center justify-center p-8">
        <div id="emergency-message-container" class="text-white text-xl sm:text-2xl md:text-3xl font-bold text-center space-y-6">
            <!-- Messages will be injected here -->
        </div>
        <button id="skip-emergency-btn" class="absolute top-5 right-5 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg z-10">SKIP</button>
        <button id="proceed-to-roles-btn" class="mt-8 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hidden transition-opacity animate-pulse">
            ì „ë¬¸ ë¶„ì•¼ ì„ íƒí•˜ê¸°
        </button>
    </div>

    <!-- Modals and Global Buttons -->
    <div id="global-buttons" class="fixed bottom-5 left-5 right-5 flex justify-between items-center z-50 pointer-events-none">
        <button id="back-to-start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105 hidden pointer-events-auto">ì²˜ìŒìœ¼ë¡œ</button>
        <button id="exit-app-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform hover:scale-105 hidden pointer-events-auto ml-auto">ì¢…ë£Œ</button>
    </div>
    
    <!-- Item Info Modal -->
    <div id="item-info-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="item-info-modal-body" class="text-white"></div>
        </div>
    </div>
    
    <!-- Item Selection Modal -->
    <div id="item-selection-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
             <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-center text-cyan-400">ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¼í’ˆ ì„ íƒ</h3>
            <div id="item-selection-modal-body" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto p-2"></div>
        </div>
    </div>

    <!-- Save/Share Modal -->
    <div id="save-share-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600 text-center">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <h3 class="text-2xl font-bold mb-6 text-cyan-400">ê²°ê³¼ ì €ì¥ ë° ê³µìœ </h3>
            <div class="flex flex-col gap-4">
                <button id="save-image-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                <button id="share-image-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">ğŸ”— ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Knowledge Modal -->
    <div id="knowledge-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span class="close-modal-btn absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="knowledge-modal-body" class="text-white"></div>
        </div>
    </div>

    <!-- General Alert/Confirm Modal -->
    <div id="alert-confirm-modal" class="modal-base">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600 text-center max-w-md">
            <h3 id="alert-confirm-title" class="text-xl font-bold mb-4 text-yellow-300"></h3>
            <p id="alert-confirm-message" class="text-slate-300 mb-6"></p>
            <div id="alert-confirm-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>
    
    <audio id="bg-music" loop></audio>

    <script>
    (function() {
        // --- App State and Data ---
        const SAVE_KEY = 'pinky-moon-survival-team-v1.4';
        const APP_VERSION = 'team-1.4';

        let emergencySequenceTimeoutId = null;
        let activeSelectionContext = { type: null, slotIndex: null };
        
        const appData = {
            emergencyMessages: [
                "ì¹˜ì§... ì¹˜ì§€ì§...", "ì—¬ê¸°ëŠ” í†µì œì‹¤, ì‘ë‹µí•˜ë¼ '{groupName}' 1í˜¸!", "ì•Œ ìˆ˜ ì—†ëŠ” ì¶©ê²©ìœ¼ë¡œ ì„ ì²´ ì†ìƒ í™•ì¸.",
                "í˜„ì¬ ìœ„ì¹˜ë¥¼ íŠ¹ì •í•  ìˆ˜ ì—†ìŒ.", "{name} ëŒ€ì›, ë‹¹ì‹ ì˜ íŒë‹¨ì— ëª¨ë‘ì˜ ìƒì¡´ì´ ë‹¬ë ¤ìˆë‹¤.", "êµ¬ì¡°ì„ ê¹Œì§€ëŠ” ì•½ 300km.",
                "ì „ë¬¸ì§€ì‹ì„ í™œìš©í•´, 15ê°œ ë¹„ìƒ ë¬¼í’ˆì˜ ìƒì¡´ ìˆœìœ„ë¥¼ ì •í•´ë¼.", "ë°˜ë“œì‹œ... ë°˜ë“œì‹œ ì‚´ì•„ë‚¨ì•„ë¼!"
            ],
            roles: {
                scientist: { name: 'ìš°ì£¼ê³¼í•™ì', knowledge: [ { text: "ì—°ì†Œ(íƒ€ëŠ” ê²ƒ)ëŠ” ì‚°ì†Œì™€ ê°™ì€ ì‚°í™”ì œê°€ ë°˜ë“œì‹œ í•„ìš”í•´ìš”." }, { text: "ì•¡ì²´ì˜ ë“ëŠ”ì ì€ ì£¼ë³€ì˜ ê¸°ì••ì— ë”°ë¼ ë‹¬ë¼ì ¸ìš”." }, { text: "ë‹¬ì—ëŠ” ê³µê¸°ê°€ ì—†ì–´ í˜¸í¡ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, ëŒ€ê¸°ì••ì´ ê±°ì˜ 0ì— ê°€ê¹Œì›Œìš”." }, { text: "ìš°ì£¼ë³µì—ëŠ” ìì²´ì ì¸ ìƒëª… ìœ ì§€(ì‚°ì†Œ ê³µê¸‰, ì˜¨ë„ ì¡°ì ˆ) ê¸°ëŠ¥ì´ ìˆì–´ìš”." }, { text: "ë‹¬ì˜ ë¨¼ì§€ëŠ” ë§¤ìš° ê³±ê³  ë‚ ì¹´ë¡œì›Œì„œ, ê¸°ê³„ ì¥ì¹˜ì— ê³ ì¥ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆì–´ìš”." }, { text: "ìš°ì£¼ì„ ì˜ ê¸ˆì† íŒŒí¸ì€ í–‡ë¹›ì„ ë°˜ì‚¬ì‹œì¼œ ë©€ë¦¬ì„œë„ ë³´ì¼ ìˆ˜ ìˆì–´ìš”." }, { text: "ë‹¬ í‘œë©´ì˜ ì˜¨ë„ëŠ” ë‚®ì—ëŠ” 120ë„, ë°¤ì—ëŠ” -170ë„ê¹Œì§€ ë³€í•´ìš”." }, { text: "ë‹¬ì˜ 'ê³ ìš”ì˜ ë°”ë‹¤'ëŠ” ì•„í´ë¡œ 11í˜¸ê°€ ì°©ë¥™í•œ ê³³ìœ¼ë¡œ ìœ ëª…í•´ìš”." }, { text: "ì§€êµ¬ì™€ ë‹¬ ì‚¬ì´ì˜ í‰ê·  ê±°ë¦¬ëŠ” ì•½ 384,400kmì˜ˆìš”." }, { text: "ë‹¬ì˜ ê°€ì¥ í° í¬ë ˆì´í„°(ì¶©ëŒ êµ¬ë©ì´)ëŠ” ë‚¨ê·¹-ì—ì´íŠ¸ì¼„ ë¶„ì§€ì˜ˆìš”." } ] },
                explorer: { name: 'íƒí—˜ê°€', knowledge: [ { text: "ì§€êµ¬ì—ì„œ ë³¸ ë³„ìë¦¬ë“¤ì€ ë‹¬ì—ì„œë„ ë³´ì—¬ìš”. ë³„ìë¦¬ë“¤ì€ ì§€êµ¬ì™€ ë‹¬ì—ì„œ ì•„ì£¼ì•„ì£¼ ë©€ì–´ìš”." }, { text: "ìê¸°ì¥(Magnetic Field)ì€ í–‰ì„±ì˜ ë‚¨ê·¹ê³¼ ë¶ê·¹ì„ ì—°ê²°í•˜ëŠ” ê±°ëŒ€í•œ ìì„ê³¼ ê°™ì•„ìš”." }, { text: "ë‹¬ì—ëŠ” ì§€êµ¬ì™€ ê°™ì€ ìê¸°ì¥ì´ ì—†ì–´ìš”." }, { text: "300kmëŠ” ì„œìš¸ì—ì„œ ë¶€ì‚°ê¹Œì§€ì˜ ê±°ë¦¬ì™€ ë¹„ìŠ·í•˜ë©°, ê±¸ì–´ì„œ ê°€ê¸°ì—” ë§¤ìš° ë¨¼ ì—¬ì •ì´ì—ìš”." }, { text: "í–‡ë¹›ì´ ë¹„ì¹˜ëŠ” ë™ì•ˆ, ê·¸ë¦¼ìì˜ ë°©í–¥ê³¼ ê¸¸ì´ë¥¼ ì´ìš©í•´ ëŒ€ëµì ì¸ ì‹œê°„ì„ íŒŒì•…í•  ìˆ˜ ìˆì–´ìš”." }, { text: "ë‚˜ì¼ë¡  ëˆì€ ë¬´ê²Œì— ë¹„í•´ ë§¤ìš° ê°•í•œ ì¸ì¥ ê°•ë„ë¡œ ì•Œë ¤ì ¸ ìˆì–´ìš”." }, { text: "ë‹¬ í‘œë©´ì€ ë‚ ì¹´ë¡œìš´ ì•”ì„ê³¼ ë¨¼ì§€ë¡œ ë®ì—¬ ìˆì–´ ì‹ ë°œì´ë‚˜ ì¥ë¹„ê°€ ì‰½ê²Œ ì†ìƒë  ìˆ˜ ìˆì–´ìš”." }, { text: "ë‹¬ì—ëŠ” ëŒ€ê¸°ê°€ ì—†ì–´ í•˜ëŠ˜ì´ í•­ìƒ ê²€ì€ìƒ‰ì´ì—ìš”." }, { text: "ë‹¬ì—ì„œ ì²˜ìŒìœ¼ë¡œ ê³¨í”„ë¥¼ ì¹œ ìš°ì£¼ë¹„í–‰ì‚¬ê°€ ìˆì–´ìš”." }, { text: "ë‹¬ íƒì‚¬ ë¡œë²„ 'ë°”ì´í¼(VIPER)'ëŠ” ë‹¬ì˜ ë‚¨ê·¹ì—ì„œ ì–¼ìŒì„ ì°¾ëŠ” ì„ë¬´ë¥¼ ìˆ˜í–‰í•  ì˜ˆì •ì´ì—ìš”." } ] },
                communicator: { name: 'í†µì‹ ì „ë¬¸ê°€', knowledge: [ { text: "FM ì „íŒŒëŠ” ì¥ì• ë¬¼ì„ í†µê³¼í•˜ì§€ ëª»í•˜ê³  ì§ì§„í•˜ëŠ” ì„±ì§ˆì´ ê°•í•´ìš”." }, { text: "ì••ì¶•ëœ ê°€ìŠ¤ë¥¼ ë°©ì¶œí•˜ë©´, ë‰´í„´ì˜ ì œ3ë²•ì¹™(ì‘ìš©-ë°˜ì‘ìš©)ì— ë”°ë¼ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ í˜ì´ ìƒê²¨ìš”." }, { text: "ë¹›ì€ ì§„ê³µ ì†ì—ì„œë„ ì „ë‹¬ë˜ë©°, ë°˜ì§ì´ëŠ” ë¬¼ì²´ëŠ” ë©€ë¦¬ì„œë„ ì‹ë³„í•˜ê¸° ì‰¬ì›Œìš”." }, { text: "ì†Œë¦¬ëŠ” ê³µê¸° ê°™ì€ ë§¤ì§ˆì´ ìˆì–´ì•¼ ì „ë‹¬ë  ìˆ˜ ìˆì–´ìš”." }, { text: "ëª¨ìŠ¤ ë¶€í˜¸(SOS: Â·Â·Â· â€” â€” â€” Â·Â·Â·)ëŠ” ê°„ë‹¨í•œ ì‹ í˜¸ë¡œ êµ¬ì¡° ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” êµ­ì œ í‘œì¤€ì´ì—ìš”." }, { text: "íƒœì–‘ì—´ ì¶©ì „ê¸°ëŠ” í•´ê°€ ë–  ìˆëŠ” ë™ì•ˆì—ë§Œ ì‘ë™í•´ìš”." }, { text: "ìµœì´ˆì˜ ì¸ê³µìœ„ì„±ì€ ì†Œë ¨ì˜ 'ìŠ¤í‘¸íŠ¸ë‹ˆí¬ 1í˜¸'ì˜€ì–´ìš”." }, { text: "í™”ì„±íƒì‚¬ì„  'íë¦¬ì˜¤ì‹œí‹°'ëŠ” ì°©ë¥™í•  ë•Œ ìŠ¤ì¹´ì´í¬ë ˆì¸ì´ë¼ëŠ” ë…íŠ¹í•œ ë°©ë²•ì„ ì‚¬ìš©í–ˆì–´ìš”." }, { text: "ì•„í´ë¡œ ê³„íšì— ì‚¬ìš©ëœ ì»´í“¨í„°ì˜ ì²˜ë¦¬ ëŠ¥ë ¥ì€ í˜„ëŒ€ì˜ ìŠ¤ë§ˆíŠ¸í°ë³´ë‹¤ í›¨ì”¬ ë‚®ì•˜ì–´ìš”." }, { text: "ë³´ì´ì € íƒì‚¬ì„ ì—ëŠ” ì§€êµ¬ì˜ ì†Œë¦¬ì™€ ê·¸ë¦¼ì„ ë‹´ì€ 'ê³¨ë“  ë ˆì½”ë“œ'ê°€ ì‹¤ë ¤ ìˆì–´ìš”." } ] },
                medic: { name: 'ì˜ë£Œì§„', knowledge: [ { text: "NASA ìš°ì£¼ë³µì—ëŠ” ìˆ˜íŠ¸ì˜ ê¸°ë°€ì„±ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œ ì•½ë¬¼ì„ íˆ¬ì—¬í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ì£¼ì…êµ¬ê°€ ìˆì–´ìš”." }, { text: "ì¸ê°„ì€ ë¬¼ ì—†ì´ëŠ” 3ì¼ ì´ìƒ ìƒì¡´í•˜ê¸° ì–´ë ¤ì›Œìš”." }, { text: "íƒˆìˆ˜ í˜„ìƒì€ ë°©í–¥ê°ê° ìƒì‹¤ê³¼ í˜¼ë€ì„ ìœ ë°œí•  ìˆ˜ ìˆì–´ìš”." }, { text: "ìš°ì£¼ ê³µê°„ì˜ ê°•í•œ ë°©ì‚¬ì„ ì€ ì¸ì²´ì— í•´ë¡œìš°ë¯€ë¡œ, ê°€ëŠ¥í•œ í•œ ëª¸ì„ ê°€ë¦¬ëŠ” ê²ƒì´ ì¢‹ì•„ìš”." }, { text: "ìŒì‹ ë†ì¶•ì•¡ì€ ë§›ì€ ì—†ì§€ë§Œ, ì‘ì€ ì–‘ìœ¼ë¡œë„ ë†’ì€ ì¹¼ë¡œë¦¬ë¥¼ ì œê³µí•´ìš”." }, { text: "ë¶„ë§ í˜•íƒœì˜ ì‹í’ˆì€ ì„­ì·¨ë¥¼ ìœ„í•´ ì•¡ì²´ê°€ í•„ìš”í•œ ê²½ìš°ê°€ ë§ì•„ìš”." }, { text: "ìƒì²˜ê°€ ì™¸ë¶€ í™˜ê²½ì— ì§ì ‘ ë…¸ì¶œë˜ë©´ ê°ì—¼ì˜ ìœ„í—˜ì´ ì»¤ì ¸ìš”." }, { text: "ì €ì²´ì˜¨ì¦ì€ ì‹ ì²´ ê¸°ëŠ¥ ì €í•˜ì˜ ì£¼ìš” ì›ì¸ ì¤‘ í•˜ë‚˜ì˜ˆìš”." }, { text: "ìš°ì£¼ë¹„í–‰ì‚¬ë“¤ì€ ìš°ì£¼ì—ì„œ í‚¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ì•½ê°„ ì»¤ì§„ë‹¤ê³  í•´ìš”." }, { text: "ë¬´ì¤‘ë ¥ ìƒíƒœì—ì„œëŠ” ê·¼ìœ¡ê³¼ ë¼ˆê°€ ì•½í•´ì§€ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ ë§¤ì¼ 2ì‹œê°„ì”© ìš´ë™í•´ì•¼ í•´ìš”." } ] }
            },
            items: [
                { id: 15, name: 'ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒì', nasaRank: 15, icon: 'ğŸ“¦', description: 'ë§ˆì°°ì„ í†µí•´ ë¶ˆì„ ë¶™ì´ëŠ” ë„êµ¬ì¸ ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
                { id: 6, name: '15m ê¸¸ì´ì˜ ë‚˜ì¼ë¡  ëˆ', nasaRank: 6, icon: 'ğŸ§¶', description: 'ê¸¸ê³  íŠ¼íŠ¼í•œ ë‚˜ì¼ë¡  ì†Œì¬ì˜ ëˆì…ë‹ˆë‹¤.' },
                { id: 2, name: 'ë¬¼ (20L)', nasaRank: 2, icon: 'ğŸ’§', description: 'ë§ˆì‹¤ ìˆ˜ ìˆëŠ” ê¹¨ë—í•œ ë¬¼ì´ 20ë¦¬í„° ë‹´ê¸´ í†µì…ë‹ˆë‹¤.' },
                { id: 10, name: 'ì‹ í˜¸ìš© ì¡°ëª…íƒ„', nasaRank: 10, icon: 'ğŸ§¨', description: 'ë‚´ì¥ëœ ì‚°í™”ì œ ë•ë¶„ì— ì‚°ì†Œ ì—†ì´ë„ íƒ€ë©´ì„œ ë°ì€ ë¹›ì„ ë‚´ëŠ” ì‹ í˜¸ìš© í­ì£½ì…ë‹ˆë‹¤. (ì‚°í™”ì œ: ë‹¤ë¥¸ ë¬¼ì§ˆì´ ì˜ íƒ€ë„ë¡ ë•ëŠ” ë¬¼ì§ˆ)' },
                { id: 8, name: 'ë‚™í•˜ì‚° ì²œ', nasaRank: 8, icon: 'ğŸª‚', description: 'ê³µê¸° ì €í•­ì„ ì´ìš©í•˜ê¸° ìœ„í•œ í¬ê³  ì§ˆê¸´ ì²œì…ë‹ˆë‹¤.' },
                { id: 1, name: 'ì‚°ì†Œí†µ 45kg (2ì •)', nasaRank: 1, icon: 'ğŸ’¨', description: 'í˜¸í¡ì— í•„ìš”í•œ ì‚°ì†Œê°€ ì••ì¶•ë˜ì–´ ë“¤ì–´ìˆëŠ” ê¸ˆì† ìš©ê¸° 2ê°œì…ë‹ˆë‹¤.' },
                { id: 13, name: 'ë¶„ìœ  í•œ ìƒì', nasaRank: 12, icon: 'ğŸ¼', description: 'ì•„ê¸°ì—ê²Œ ì˜ì–‘ì„ ê³µê¸‰í•˜ê¸° ìœ„í•œ ë¶„ë§ í˜•íƒœì˜ ìš°ìœ ì…ë‹ˆë‹¤.' },
                { id: 5, name: 'íƒœì–‘ì—´ ì¶©ì „ì‹ FM ë¬´ì „ê¸°', nasaRank: 5, icon: 'ğŸ“»', description: 'íƒœì–‘ ë¹›ìœ¼ë¡œ ì¶©ì „í•˜ì—¬ ë‹¨ê±°ë¦¬ ì£¼íŒŒìˆ˜ ë³€ì¡°(FM) ë°©ì‹ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 12, name: 'íœ´ëŒ€ìš© ë‚œë°©ê¸°', nasaRank: 13, icon: 'ğŸ”¥', description: 'ì£¼ë³€ì„ ë”°ëœ»í•˜ê²Œ ë°ìš°ëŠ” íœ´ëŒ€ìš© ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 3, name: 'ë³„ìë¦¬ ì§€ë„', nasaRank: 3, icon: 'ğŸ—ºï¸', description: 'ì§€êµ¬ ë¶ë°˜êµ¬ì—ì„œ ë³´ì´ëŠ” ë³„ë“¤ì˜ ìœ„ì¹˜ë¥¼ í‘œì‹œí•œ ì²œì²´ ì§€ë„ì…ë‹ˆë‹¤.' },
                { id: 11, name: '45êµ¬ê²½ ê¶Œì´ 2ì •', nasaRank: 11, icon: 'ğŸ”«', description: 'ì´ì•Œì„ ë°œì‚¬í•˜ëŠ” ê°œì¸ìš© í™”ê¸° 2ì •ì…ë‹ˆë‹¤.' },
                { id: 7, name: 'êµ¬ê¸‰ ìƒì (ì£¼ì‚¬ê¸° í¬í•¨)', nasaRank: 7, icon: 'ğŸ©¹', description: 'ì†Œë…ì•½, ë¶•ëŒ€, ì˜ë£Œìš© í…Œì´í”„, ì£¼ì‚¬ê¸° ë“±ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
                { id: 4, name: 'ìŒì‹ (ìš°ì£¼ì‹)', nasaRank: 4, icon: 'ğŸ”', description: 'ë¬¼ ì—†ì´ ë°”ë¡œ ì„­ì·¨í•  ìˆ˜ ìˆë„ë¡ ë†ì¶•ëœ ë¹„ìƒ ì‹ëŸ‰ì…ë‹ˆë‹¤.' },
                { id: 14, name: 'ìì„ ë‚˜ì¹¨ë°˜', nasaRank: 14, icon: 'ğŸ§­', description: 'ì§€êµ¬ì˜ ìê¸°ì¥ì„ ì´ìš©í•˜ì—¬ ë°©í–¥ì„ ê°€ë¦¬í‚¤ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.' },
                { id: 9, name: 'êµ¬ëª… ê³ ë¬´ë³´íŠ¸', nasaRank: 9, icon: 'ğŸš¤', description: 'ë¬¼ ìœ„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³ ë¬´ ì¬ì§ˆì˜ ë³´íŠ¸ì´ë©°, ì´ì‚°í™”íƒ„ì†Œ ê°€ìŠ¤í†µìœ¼ë¡œ ë¶€í’€ë¦½ë‹ˆë‹¤.' }
            ],
            state: {}
        };

        const dom = {
            appContainer: document.getElementById('app-container'),
            rankListEl: document.getElementById('rank-list'),
            groupRankListEl: document.getElementById('group-rank-list'),
            itemInfoModalEl: document.getElementById('item-info-modal'),
            itemInfoModalBodyEl: document.getElementById('item-info-modal-body'),
            itemSelectionModalEl: document.getElementById('item-selection-modal'),
            itemSelectionModalBodyEl: document.getElementById('item-selection-modal-body'),
            saveShareModalEl: document.getElementById('save-share-modal'),
            knowledgeModalEl: document.getElementById('knowledge-modal'),
            knowledgeModalBodyEl: document.getElementById('knowledge-modal-body'),
            alertConfirmModalEl: document.getElementById('alert-confirm-modal'),
            alertConfirmTitle: document.getElementById('alert-confirm-title'),
            alertConfirmMessage: document.getElementById('alert-confirm-message'),
            alertConfirmButtons: document.getElementById('alert-confirm-buttons'),
            emergencyScreen: document.getElementById('emergency-screen'),
            emergencyMessageContainer: document.getElementById('emergency-message-container'),
            proceedToRolesBtn: document.getElementById('proceed-to-roles-btn'),
            skipEmergencyBtn: document.getElementById('skip-emergency-btn'),
            groupNameInput: document.getElementById('groupNameInput'),
            studentNumberInput: document.getElementById('studentNumberInput'),
            studentNameInput: document.getElementById('studentNameInput'),
            roleTitle: document.getElementById('role-title'),
            knowledgeList: document.getElementById('knowledge-list'),
            finishIndividualButton: document.getElementById('finish-individual-button'),
            finishIndividualButtonCounter: document.getElementById('finish-individual-button-counter'),
            finishGroupButton: document.getElementById('finish-group-button'),
            finishGroupButtonCounter: document.getElementById('finish-group-button-counter'),
            finalGroupName: document.getElementById('final-group-name'),
            finalStudentNumber: document.getElementById('final-student-number'),
            finalStudentName: document.getElementById('final-student-name'),
            finalRole: document.getElementById('final-role'),
            individualScoreSummary: document.getElementById('individual-score-summary'),
            groupScoreSummary: document.getElementById('group-score-summary'),
            individualFinalList: document.getElementById('individual-final-list'),
            groupFinalList: document.getElementById('group-final-list'),
            backToStartBtn: document.getElementById('back-to-start-btn'),
            exitAppBtn: document.getElementById('exit-app-btn'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            fsEnterIcon: document.getElementById('fs-enter-icon'),
            fsExitIcon: document.getElementById('fs-exit-icon'),
            bgMusic: document.getElementById('bg-music'),
        };
        
        // --- All Functions Defined Here ---
        const saveState = () => {
            try {
                if (appData.state.currentScreen === 'welcome-screen' || appData.state.currentScreen === 'setup-screen' || appData.state.currentScreen === 'emergency-screen') return;

                const saveReasons = (type) => {
                    const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                    const listEl = type === 'individual' ? dom.rankListEl : dom.groupRankListEl;
                    const reasonAttribute = type === 'individual' ? 'data-reason-for-item' : 'data-reason-for-group-item';

                    rankedItems.forEach((itemData, index) => {
                        if (itemData) {
                            const textarea = listEl.querySelector(`textarea[${reasonAttribute}="${itemData.id}"]`);
                            if (textarea) rankedItems[index].reason = textarea.value;
                        }
                    });
                };
                
                if(appData.state.currentScreen === 'main-screen') saveReasons('individual');
                if(appData.state.currentScreen === 'group-ranking-screen') saveReasons('group');

                localStorage.setItem(SAVE_KEY, JSON.stringify({ ...appData.state, version: APP_VERSION }));
            } catch (e) { console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜:", e); }
        };

        const autoSave = () => saveState();
        
        const getNewState = () => ({
            currentScreen: 'setup-screen',
            groupName: '', studentName: '', studentNumber: '',
            selectedRole: null,
            rankedItems: Array(15).fill(null),
            groupRankedItems: Array(15).fill(null),
        });

        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            dom.emergencyScreen.style.display = 'none';

            const activeScreen = document.getElementById(screenId);
            if (screenId === 'emergency-screen') {
                dom.emergencyScreen.style.display = 'flex';
                [dom.backToStartBtn, dom.exitAppBtn].forEach(btn => btn.classList.add('hidden'));
            } else if (activeScreen) {
                activeScreen.classList.add('active-screen');
                const isIntro = screenId === 'welcome-screen' || screenId === 'setup-screen';
                [dom.backToStartBtn, dom.exitAppBtn].forEach(btn => btn.classList.toggle('hidden', isIntro));
            }
            appData.state.currentScreen = screenId;
            if (screenId !== 'welcome-screen' && screenId !== 'setup-screen' && screenId !== 'emergency-screen') saveState();
        };

        const restartApp = () => {
            localStorage.removeItem(SAVE_KEY);
            window.location.reload();
        };
        
        const openModal = (modalEl) => modalEl.classList.add('show');
        const closeModal = (modalEl) => modalEl.classList.remove('show');

        const showAlert = (message, title = 'ì•Œë¦¼') => {
            dom.alertConfirmTitle.textContent = title;
            dom.alertConfirmMessage.textContent = message;
            dom.alertConfirmButtons.innerHTML = `<button class="modal-ok-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">í™•ì¸</button>`;
            openModal(dom.alertConfirmModalEl);
        };

        const showConfirm = (message, onConfirm, title = 'í™•ì¸', options = {}) => {
            const {
                onCancel = () => {},
                okText = 'í™•ì¸',
                cancelText = 'ì·¨ì†Œ',
                okClass = 'bg-red-600 hover:bg-red-700',
                cancelClass = 'bg-gray-500 hover:bg-gray-600'
            } = options;

            dom.alertConfirmTitle.textContent = title;
            dom.alertConfirmMessage.textContent = message;
            dom.alertConfirmButtons.innerHTML = `
                <button class="modal-cancel-btn ${cancelClass} text-white font-bold py-2 px-6 rounded-lg">${cancelText}</button>
                <button class="modal-ok-btn ${okClass} text-white font-bold py-2 px-6 rounded-lg">${okText}</button>
            `;
            openModal(dom.alertConfirmModalEl);
            
            dom.alertConfirmModalEl.querySelector('.modal-ok-btn').onclick = () => { closeModal(dom.alertConfirmModalEl); onConfirm(); };
            dom.alertConfirmModalEl.querySelector('.modal-cancel-btn').onclick = () => { closeModal(dom.alertConfirmModalEl); onCancel(); };
        };

        const updateFullscreenIcons = () => {
            if (document.fullscreenElement) {
                dom.fsEnterIcon.classList.add('hidden');
                dom.fsExitIcon.classList.remove('hidden');
            } else {
                dom.fsEnterIcon.classList.remove('hidden');
                dom.fsExitIcon.classList.add('hidden');
            }
        };

        const toggleFullScreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showAlert(`ì „ì²´í™”ë©´ ëª¨ë“œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}`);
                });
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        };

        const startMission = () => {
            appData.state.groupName = dom.groupNameInput.value.trim();
            appData.state.studentName = dom.studentNameInput.value.trim();
            appData.state.studentNumber = dom.studentNumberInput.value;
            if (!appData.state.groupName || !appData.state.studentName || !appData.state.studentNumber) {
                showAlert('ëª¨ë‘  ì´ë¦„, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥(ì„ íƒ)í•´ì£¼ì„¸ìš”!');
                return;
            }
            saveState();
            showEmergencySequence();
        };
        
        const showEmergencySequence = () => {
            showScreen('emergency-screen');
            dom.emergencyMessageContainer.innerHTML = '';
            dom.proceedToRolesBtn.classList.add('hidden');
            dom.skipEmergencyBtn.classList.remove('hidden');
            if (dom.bgMusic) {
                dom.bgMusic.src = 'u are in danger.mp3'; // ìŒì•… íŒŒì¼ ê²½ë¡œ
                dom.bgMusic.play().catch(e => console.log("ìŒì•… ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.", e));
            }

            let messageIndex = 0;
            const showNextMessage = () => {
                if (emergencySequenceTimeoutId) clearTimeout(emergencySequenceTimeoutId);
                if (messageIndex >= appData.emergencyMessages.length) {
                    dom.skipEmergencyBtn.classList.add('hidden');
                    dom.proceedToRolesBtn.classList.remove('hidden');
                    return;
                }
                const p = document.createElement('p');
                p.className = 'keep-all';
                const rawMessage = appData.emergencyMessages[messageIndex];
                const studentName = appData.state.studentName || 'ëŒ€ì›';
                const groupName = appData.state.groupName || 'ëª¨ë‘ ';
                p.textContent = rawMessage.replace('{name}', studentName).replace('{groupName}', groupName);
                dom.emergencyMessageContainer.appendChild(p);
                messageIndex++;
                emergencySequenceTimeoutId = setTimeout(showNextMessage, 2200);
            };
            showNextMessage();
        };
        
        const stopMusicAndClear = () => {
            if (dom.bgMusic) {
                dom.bgMusic.pause();
                dom.bgMusic.currentTime = 0;
            }
        };

        const skipEmergencySequence = () => {
            if (emergencySequenceTimeoutId) clearTimeout(emergencySequenceTimeoutId);
            const studentName = appData.state.studentName || 'ëŒ€ì›';
            const groupName = appData.state.groupName || 'ëª¨ë‘ ';
            dom.emergencyMessageContainer.innerHTML = appData.emergencyMessages
                .map(msg => `<p style="animation: none; opacity: 1;" class="keep-all">${msg.replace('{name}', studentName).replace('{groupName}', groupName)}</p>`).join('');
            dom.skipEmergencyBtn.classList.add('hidden');
            dom.proceedToRolesBtn.classList.remove('hidden');
        };

        const selectRole = (roleId) => {
            appData.state.selectedRole = roleId;
            const role = appData.roles[roleId];
            dom.roleTitle.innerText = `[${role.name}]`;
            dom.knowledgeList.innerHTML = `
                <h4 class="text-lg font-bold text-orange-300 md:col-span-2">ğŸš€ ì „ë¬¸ ì§€ì‹</h4>
                ${role.knowledge.map(fact => `<div class="bg-slate-700 p-3 rounded keep-all">- ${fact.text}</div>`).join('')}
                <hr class="border-slate-600 my-2 md:col-span-2">
                <h4 class="text-lg font-bold text-cyan-300 md:col-span-2">ğŸ’ ë¬¼í’ˆ ì •ë³´</h4>
                ${appData.items.map(item => `
                    <div class="bg-slate-700 p-3 rounded">
                        <p class="font-bold">${item.icon} ${item.name}</p>
                        <p class="text-sm text-slate-400 mt-1 keep-all">${item.description}</p>
                    </div>
                `).join('')}
            `;
            showScreen('knowledge-screen');
        };
        
        const updateFinishButtonState = (type) => {
            const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
            const button = type === 'individual' ? dom.finishIndividualButton : dom.finishGroupButton;
            const counter = type === 'individual' ? dom.finishIndividualButtonCounter : dom.finishGroupButtonCounter;
            
            const itemCount = rankedItems.filter(item => item !== null).length;
            counter.textContent = `(${itemCount}/15)`;
            button.disabled = (itemCount !== 15);
        };
        
        const renderRankingSlots = (type) => {
            const listEl = type === 'individual' ? dom.rankListEl : dom.groupRankListEl;
            const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
            const reasonAttribute = type === 'individual' ? 'data-reason-for-item' : 'data-reason-for-group-item';

            listEl.innerHTML = '';
            rankedItems.forEach((itemData, index) => {
                const slotEl = document.createElement('div');
                slotEl.dataset.slotIndex = index;
                slotEl.dataset.rankType = type;

                if (itemData) {
                    const item = appData.items.find(i => i.id === itemData.id);
                    slotEl.className = 'rank-slot filled bg-slate-700 p-3 rounded-md';
                    slotEl.dataset.itemId = item.id;
                    slotEl.innerHTML = `
                        <div class="flex items-center gap-2 mb-2">
                            <span class="drag-handle">â ¿</span>
                            <div class="flex-1 min-w-0 font-bold text-lg text-orange-400 flex items-center pointer-events-none">
                                <span class="rank-number mr-2">${index + 1}ìœ„.</span>
                                <span>${item.icon} ${item.name}</span>
                            </div>
                            <button data-info-id="${item.id}" class="text-xs bg-sky-600 hover:bg-sky-500 text-white py-1 px-2 rounded ml-auto flex-shrink-0">ì •ë³´</button>
                            <button data-clear-slot="${index}" data-clear-type="${type}" class="text-xs bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded flex-shrink-0">X</button>
                        </div>
                        <textarea ${reasonAttribute}="${item.id}" class="w-full bg-slate-900 text-white rounded p-2 text-sm" rows="2" placeholder="ì´ ë¬¼í’ˆì„ ì´ ìˆœìœ„ë¡œ ì •í•œ ì´ìœ ëŠ”...">${itemData.reason || ''}</textarea>
                    `;
                } else {
                    slotEl.className = 'rank-slot empty bg-slate-900/50 p-3 rounded-md border-2 border-slate-700 flex items-center justify-center h-24 transition';
                    slotEl.innerHTML = `<div class="text-center text-slate-500"><span class="font-bold text-xl">${index + 1}ìœ„</span><p class="text-sm">í´ë¦­í•˜ì—¬ ë¬¼í’ˆ ì„ íƒ</p></div>`;
                }
                listEl.appendChild(slotEl);
            });
            updateFinishButtonState(type);
        };
        
        const openItemSelectionModal = (slotIndex, type) => {
            activeSelectionContext = { type, slotIndex };
            const rankedItemIds = new Set( (type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems).filter(Boolean).map(item => item.id) );
            const availableItems = appData.items.filter(item => !rankedItemIds.has(item.id));
            
            dom.itemSelectionModalBodyEl.innerHTML = availableItems.length ? 
                availableItems.map(item => `
                    <button class="p-3 bg-slate-700 hover:bg-slate-600 rounded-lg text-left transition" data-item-id="${item.id}">
                        <p class="font-bold text-lg">${item.icon} ${item.name}</p>
                    </button>
                `).join('') : 
                `<p class="text-center text-slate-400 col-span-full">ëª¨ë“  ë¬¼í’ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
            
            openModal(dom.itemSelectionModalEl);
        };

        const generateReport = () => {
            dom.finalGroupName.textContent = appData.state.groupName;
            dom.finalStudentName.textContent = appData.state.studentName;
            dom.finalStudentNumber.textContent = appData.state.studentNumber;
            dom.finalRole.textContent = (appData.state.selectedRole && appData.roles[appData.state.selectedRole]?.name) || 'ë¯¸ì •';
            
            const calculateScoreAndRenderList = (type) => {
                const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                const listEl = type === 'individual' ? dom.individualFinalList : dom.groupFinalList;
                const summaryEl = type === 'individual' ? dom.individualScoreSummary : dom.groupScoreSummary;
                
                let totalScore = 0;
                listEl.innerHTML = rankedItems.map((itemData, index) => {
                    if (!itemData) return '';
                    const item = appData.items.find(i => i.id === itemData.id);
                    const userRank = index + 1;
                    totalScore += Math.abs(userRank - item.nasaRank);
                    return `
                        <div class="p-2 bg-slate-900 rounded-md text-sm">
                            <p class="font-bold">${userRank}ìœ„. ${item.icon} ${item.name}</p>
                            <p class="text-sm text-slate-400 mt-1 pl-3 keep-all">ì´ìœ : ${itemData.reason || 'ì‘ì„±í•˜ì§€ ì•ŠìŒ'}</p>
                        </div>
                    `;
                }).join('');

                let evaluation = '';
                if (totalScore <= 25) { evaluation = 'NASAì—ì„œ ì—°ë½ì˜µë‹ˆë‹¤. ë‹¹ì‹ ì€ ì™¸ê³„ì¸ì¸ê°€ìš”?'; }
                else if (totalScore <= 32) { evaluation = 'ë‹¬ ë¶€ë™ì‚° íˆ¬ì ì¶”ì²œ! ë‹¹ì‹ ì€ ì´ë¯¸ ë‹¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.'; }
                else if (totalScore <= 45) { evaluation = 'ì•„ìŠ¬ì•„ìŠ¬... ì§€êµ¬ì— ê°ˆ ìˆ˜ ìˆê² ì£ ?'; }
                else if (totalScore <= 55) { evaluation = 'ì§€êµ¬ì— ìˆëŠ” ê°€ì¡±... ìƒê°ë‚˜ì‹œë‚˜ìš”?'; }
                else if (totalScore <= 70) { evaluation = 'í˜¹ì‹œ í•˜ê³  ì‹¶ì€ ë§ì´ ìˆë‚˜ìš”?'; }
                else { evaluation = 'ê·¸ë™ì•ˆ í•¨ê»˜í•´ì„œ í–‰ë³µí–ˆì–´ìš”.'; }
                
                summaryEl.innerHTML = `
                    <p class="text-lg font-bold">ì´ì : <span class="text-red-400">${totalScore}ì </span></p>
                    <p class="text-lg font-bold mt-1">"${evaluation}"</p>
                `;
            };

            calculateScoreAndRenderList('individual');
            calculateScoreAndRenderList('group');
            showScreen('report-screen');
        };

        const openKnowledgeModal = () => {
            if (!appData.state.selectedRole) return;
            const role = appData.roles[appData.state.selectedRole];
            dom.knowledgeModalBodyEl.innerHTML = `
                <h3 class="text-2xl font-bold mb-4 text-center">ì •ë³´ ë‹¤ì‹œë³´ê¸°</h3>
                <div class="max-h-[60vh] overflow-y-auto p-2 space-y-4">
                    <div>
                        <h4 class="text-lg font-bold text-orange-300 mb-2">ğŸš€ [${role.name}] ì „ë¬¸ ì§€ì‹</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-300">
                            ${role.knowledge.map(fact => `<li class="keep-all">${fact.text}</li>`).join('')}
                        </ul>
                    </div>
                    <hr class="border-slate-600 my-4">
                    <div>
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">ğŸ’ ë¬¼í’ˆ ì •ë³´</h4>
                        <div class="space-y-3">
                            ${appData.items.map(item => `
                                <div class="bg-slate-900 p-3 rounded">
                                    <p class="font-bold">${item.icon} ${item.name}</p>
                                    <p class="text-sm text-slate-400 mt-1 keep-all">${item.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            openModal(dom.knowledgeModalEl);
        };
        
        const restoreSession = () => {
            try {
                const savedStateJSON = localStorage.getItem(SAVE_KEY);
                if (!savedStateJSON) return false;
                
                const savedState = JSON.parse(savedStateJSON);
                 if (savedState.version !== APP_VERSION) {
                    localStorage.removeItem(SAVE_KEY);
                    return false;
                }

                appData.state = savedState;
                dom.groupNameInput.value = appData.state.groupName || '';
                dom.studentNumberInput.value = appData.state.studentNumber || '';
                dom.studentNameInput.value = appData.state.studentName || '';

                const screenToRestore = appData.state.currentScreen;
                showScreen(screenToRestore);

                if (screenToRestore === 'main-screen') renderRankingSlots('individual');
                if (screenToRestore === 'group-ranking-screen') renderRankingSlots('group');
                if (screenToRestore === 'report-screen') generateReport();

                return true;
            } catch (e) {
                localStorage.removeItem(SAVE_KEY);
                return false;
            }
        };

        const generateReportCanvas = () => {
            const reportContent = document.getElementById('report-content');
            
            const individualList = document.getElementById('individual-final-list');
            const groupList = document.getElementById('group-final-list');
            const oldIndividualHeight = individualList.style.maxHeight;
            const oldGroupHeight = groupList.style.maxHeight;
            individualList.style.maxHeight = 'none';
            groupList.style.maxHeight = 'none';
            individualList.style.overflow = 'visible';
            groupList.style.overflow = 'visible';

            return new Promise((resolve) => {
                html2canvas(reportContent, { 
                    backgroundColor: "#0a192f",
                    onclone: (doc) => { doc.getElementById('report-content').style.color = '#e6f1ff'; }
                }).then(canvas => {
                    individualList.style.maxHeight = oldIndividualHeight;
                    groupList.style.maxHeight = oldGroupHeight;
                    individualList.style.overflow = 'auto';
                    groupList.style.overflow = 'auto';
                    resolve(canvas);
                });
            });
        };
        
        const downloadReport = () => {
             generateReportCanvas().then(canvas => {
                const link = document.createElement('a');
                const groupName = appData.state.groupName || 'ì†Œì†ì—†ìŒ';
                const studentNumber = appData.state.studentNumber || '00';
                const studentName = appData.state.studentName || 'ì´ë¦„ì—†ìŒ';
                link.download = `ë‹¬ìƒì¡´_${groupName}_${studentNumber}ë²ˆ_${studentName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        };

        const shareReport = async () => {
            try {
                const canvas = await generateReportCanvas();
                canvas.toBlob(async (blob) => {
                    const groupName = appData.state.groupName || 'ì†Œì†ì—†ìŒ';
                    const studentNumber = appData.state.studentNumber || '00';
                    const studentName = appData.state.studentName || 'ì´ë¦„ì—†ìŒ';
                    const fileName = `ë‹¬ìƒì¡´_${groupName}_${studentNumber}ë²ˆ_${studentName}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'ë‚˜ì˜ ë‹¬ ìƒì¡´ ë³´ê³ ì„œ',
                            text: 'ë‹¬ì—ì„œ ì‚´ì•„ë‚¨ê¸°! ìš°ë¦¬ ëª¨ë‘ ì˜ ì ìˆ˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!',
                        });
                    } else {
                        showAlert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'ì•Œë¦¼');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('ê³µìœ  ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
                showAlert('ì´ë¯¸ì§€ë¥¼ ê³µìœ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
            }
        };

        const handleBodyClick = (event) => {
            const target = event.target;
            const roleCard = target.closest('.role-card');
            const emptySlot = target.closest('.rank-slot.empty');
            const infoButton = target.closest('[data-info-id]');
            const clearButton = target.closest('[data-clear-slot]');
            const itemSelectionButton = target.closest('#item-selection-modal-body button');
            const modalClose = target.closest('.close-modal-btn') || (target.classList.contains('modal-base') && !target.querySelector('.modal-content')) || target.closest('.modal-ok-btn') || target.closest('.modal-cancel-btn');

            const actions = {
                'start-class-btn': () => {
                    if (localStorage.getItem(SAVE_KEY)) {
                        showConfirm(
                            'ì €ì¥ëœ ì§„í–‰ ìƒí™©ì„ ì´ì–´ì„œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                            () => { // onConfirm -> Continue
                                if (!restoreSession()) {
                                    showAlert("ì´ì–´í•  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.", "ì˜¤ë¥˜");
                                    restartApp();
                                }
                            },
                            'ì§„í–‰ ìƒí™© ë°œê²¬',
                            { 
                                onCancel: () => { // onCancel -> Start New
                                    appData.state = getNewState();
                                    showScreen('setup-screen');
                                },
                                okText: 'ì´ì–´í•˜ê¸°',
                                cancelText: 'ìƒˆë¡œ ì‹œì‘',
                                okClass: 'bg-green-600 hover:bg-green-700',
                                cancelClass: 'bg-red-600 hover:bg-red-700'
                            }
                        );
                    } else {
                        appData.state = getNewState();
                        showScreen('setup-screen');
                    }
                },
                'start-mission-btn': startMission,
                'skip-emergency-btn': () => { skipEmergencySequence(); stopMusicAndClear(); },
                'proceed-to-roles-btn': () => { stopMusicAndClear(); showScreen('role-screen'); },
                'go-to-ranking-btn': () => { showScreen('main-screen'); renderRankingSlots('individual'); },
                'finish-individual-button': () => { showScreen('group-ranking-screen'); renderRankingSlots('group'); },
                'finish-group-button': generateReport,
                'open-knowledge-modal-btn': openKnowledgeModal,
                'open-knowledge-modal-btn-group': openKnowledgeModal,
                'back-to-start-btn': () => showConfirm('ì§€ê¸ˆê¹Œì§€ì˜ ì§„í–‰ ìƒí™©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', restartApp, 'ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°', { okText: 'í™•ì¸', cancelText: 'ì·¨ì†Œ' }),
                'exit-app-btn': () => showConfirm('ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì€ ì €ì¥ë©ë‹ˆë‹¤.', () => window.close(), 'ì¢…ë£Œ', { okText: 'ì¢…ë£Œ', cancelText: 'ì·¨ì†Œ' }),
                'restart-btn': () => showConfirm('ì •ë§ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', restartApp, 'ë‹¤ì‹œ ì‹œì‘í•˜ê¸°', { okText: 'ë‹¤ì‹œ ì‹œì‘', cancelText: 'ì·¨ì†Œ' }),
                'open-save-share-modal-btn': () => openModal(dom.saveShareModalEl),
                'save-image-btn': () => { closeModal(dom.saveShareModalEl); downloadReport(); },
                'share-image-btn': () => { closeModal(dom.saveShareModalEl); shareReport(); },
            };

            if (actions[target.id]) {
                actions[target.id]();
            } else if (roleCard) {
                selectRole(roleCard.dataset.role);
            } else if (emptySlot) {
                openItemSelectionModal(parseInt(emptySlot.dataset.slotIndex, 10), emptySlot.dataset.rankType);
            } else if (infoButton) {
                const item = appData.items.find(i => i.id == infoButton.dataset.infoId);
                if (item) {
                    dom.itemInfoModalBodyEl.innerHTML = `<h3 class="text-2xl font-bold mb-4">${item.icon} ${item.name}</h3><p class="keep-all">${item.description || 'ì •ë³´ ì—†ìŒ'}</p>`;
                    openModal(dom.itemInfoModalEl);
                }
            } else if (clearButton) {
                const slotIndex = parseInt(clearButton.dataset.clearSlot, 10);
                const type = clearButton.dataset.clearType;
                const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                rankedItems[slotIndex] = null;
                renderRankingSlots(type);
                autoSave();
            } else if (itemSelectionButton) {
                const { type, slotIndex } = activeSelectionContext;
                const rankedItems = type === 'individual' ? appData.state.rankedItems : appData.state.groupRankedItems;
                rankedItems[slotIndex] = { id: parseInt(itemSelectionButton.dataset.itemId, 10), reason: '' };
                closeModal(dom.itemSelectionModalEl);
                renderRankingSlots(type);
                autoSave();
            } else if (modalClose) {
                closeModal(target.closest('.modal-base'));
            }
        };
        
        const initialize = () => {
            for (let i = 1; i <= 40; i++) {
                const opt = document.createElement('option');
                opt.value = String(i).padStart(2, '0');
                opt.textContent = `${i}ë²ˆ`;
                dom.studentNumberInput.appendChild(opt);
            }

            dom.fullscreenBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', updateFullscreenIcons);
            document.body.addEventListener('click', handleBodyClick);
            
            ['groupNameInput', 'studentNameInput', 'studentNumberInput'].forEach(id => {
                dom[id].addEventListener('input', () => { appData.state[id.replace('Input','')] = dom[id].value; });
            });
            dom.rankListEl.addEventListener('input', (e) => { if(e.target.matches('textarea')) autoSave(); });
            dom.groupRankListEl.addEventListener('input', (e) => { if(e.target.matches('textarea')) autoSave(); });
            
            new Sortable(dom.rankListEl, { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
                const itemData = appData.state.rankedItems.splice(evt.oldIndex, 1)[0];
                appData.state.rankedItems.splice(evt.newIndex, 0, itemData);
                renderRankingSlots('individual');
                autoSave();
            }});
            new Sortable(dom.groupRankListEl, { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
                const itemData = appData.state.groupRankedItems.splice(evt.oldIndex, 1)[0];
                appData.state.groupRankedItems.splice(evt.newIndex, 0, itemData);
                renderRankingSlots('group');
                autoSave();
            }});
            
            appData.state = getNewState();
            showScreen('welcome-screen');
            updateFullscreenIcons();
            setInterval(saveState, 30000);
            window.addEventListener('beforeunload', saveState);
            document.addEventListener('visibilitychange', () => { if (document.hidden) saveState(); });
        };
        
        initialize();
    })();
    </script>
</body>
</html>
